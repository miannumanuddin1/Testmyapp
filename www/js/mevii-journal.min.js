var _journalIDEditing = "";
var _journals = [];
var _previousJournalPage = "";

function InitializeJournal(){

	var today = moment().format('dddd MMM Do, YYYY');
	$('#todaysDate').html(today);

	$('.viewJournalsBtn').on('click', function(){
        _previousJournalPage = "";
        ShowyClose('#pageJournalView');
        LoadCompletedJournals();
    });
	$('.createJournalBtn').on('click', function(){
		ResetJournalTool();
		_previousJournalPage = "";
		$('#todaysDate').html(today);
		MovePageLeft('#pageJournalCreate', _currentPage);
	});

	$('.searchJournalsBtn').on('click', function(){
		_previousJournalPage = 'search';
		ClearJournalSearchForm();
		MovePageLeft('#pageJournalSearch', _currentPage);
	});

	$('#journalSubmitBtn').off();
	$('#journalSubmitBtn').on('click', function(){
		SaveJournal();
	});

	$('.journalFeeling').on('click', function(){
		var selected = this;
		ClearSmiley();

		var clickedSource = $(selected).attr('src');

		clickedSource = clickedSource.slice(0, -4);
		clickedSource = clickedSource + '-Red.png';
		$(selected).attr('src', clickedSource);
		$(selected).addClass('chosenSmiley');
	});

	$('#journalCancelBtn').on('click', function(){
		ResetJournalTool();
		if (_isEmbeddedJournal){
			_isEmbeddedJournal = false;
			ShowNextPage(); // in contentengine...
		}
		else {
			LoadCompletedJournals();
			if(_previousJournalPage == 'search'){
				MovePageRight('#pageJournalSearch', _currentPage);
			} else {
				MovePageRight('#pageJournalView', _currentPage);
			}
		}
	});

	$('#journalWhatTagSort').change(function(){
		SortJournalsWhat();
	});

	$('#submitJournalSearchBtn').on('click', function(){
		FilterAndSearch();
	});
}

function ClearJournalSearchForm(){
	$('#journalSearchDate').val("");
	$('#journalWhatTagSort').val('');
	$('#journalSearchResults').html("");
}

function ClearSmiley(){
	var list = $('#journalScale img');

	for (var i = 0; i < list.length; i++) {
		var img = list[i];
		var index = i + 1;

		$(img).removeClass('chosenSmiley');
		$(img).attr('src', 'img/assets/iconJournalSmiley' + index + '.png');
	}
}

function FilterAndSearch(){
	_journals = [];

	var date = $('#journalSearchDate').val();
	var topic = $('#journalWhatTagSort :selected').text();
	if(topic == "Topic"){
		topic = "";
	}
	var searchData = { userID: _user.ID, tag: topic, date: date };
	// alert(JSON.stringify(searchData));

	if(date === "" && topic === ""){
		ShowError('Please enter search criteria.');
	} else {
		$.ajax({
			type: "GET",
			url: config.Path + '/journalentry/search',
			data: searchData
		}).done(function(data){
			if(data === ''){
				ShowError('No matches found.');
			} else {
				var i = 0;
				var html = '';
				var journal;
				var date = '';

				if (data.length === 0){
					ShowError('No entries found matching those criteria.');
				}
				else {
					$.scrollTo('#submitJournalSearchBtn', 300);
				}

				for(i = 0; i < data.length; i++){
					journal = data[i];
					_journals.push(journal);

					date = moment(journal.JournalDate).format("MMM DD, YYYY");
					month = moment(journal.JournalDate).format("MMMM");

					html += '<div class="journalRow" id="' + journal.ID + '">';
					html += '<div class="journalName font700 journalNameSearch">' + journal.Title + '</div>';
					html += '<div class="journalDate journalDateSearch">' + date + '</div>';
					html += '<div class="journalWhat">' + journal.What + '</div>';
					html += '<div class="journalView">View</div>';
					html += '</div>';
				}

				$('#journalSearchResults').html(html);

				$('.journalRow').off();
				$('.journalRow').on('click', function(){
					_journalIDEditing = $(this).attr('id');
					// alert(_goalIDEditing);
					PopulateJournal();
					MovePageLeft('#pageJournalCreate', _currentPage);
				});
			} //end if/else

		}); //end .done
	} // end if/else
}

function SaveJournal(){
	var journalTitle = $('#journalTitle').val();
	var journalText = $('#journalText').val();
	var journalWhatTag = $('#journalWhatTag option:selected').val();
	var smiley = $('.chosenSmiley').attr('id');

	if(journalWhatTag === ""){
		ShowError("Please select a topic.");
		return;
	}

	$('#journalSubmitBtn').prop('disabled', true);

	if(journalTitle === ""){
		journalTitle = 'Journal Entry: ' + moment().format("MMMM Do YYYY");
	}

	var journalData = { UserID: _user.ID, ID: _journalIDEditing, Title: journalTitle, Entry: journalText, Mood: smiley, What: journalWhatTag };

	ShowLoader();
	LogInfo("Saving new journal: " + JSON.stringify(journalData));

	$.ajax({
		type: "POST",
		url: config.Path + '/journalentry/save',
		data: journalData
	}).done(function(data){
		if (data === null){
			HandleError("journalentry/save returned null");
			return;
		}


		$('#journalSubmitBtn').prop('disabled', false);

		ResetJournalTool();
		LoadCompletedJournals();
		ShowSuccess("Your journal entry has been saved.");
		HideLoader();

		if (_isEmbeddedJournal){
			_isEmbeddedJournal = false;
			ShowNextPage(); // in contentengine...
			return;
		}

		if (_previousJournalPage=="search"){
			MovePageRight('#pageJournalSearch', _currentPage);
		} else {
			MovePageRight('#pageJournalView', _currentPage);
			// _previousJournalPage = "";
		}


	});
}

function ResetJournalTool(){
	$('#journalTitle').val("");
	$('#journalText').val("");
	$('#journalWhatTag').val("").attr('selected', 'selected');

	ClearSmiley();

	_journalIDEditing = null;
}

function LoadCompletedJournals(){
	ShowLoader();
	$.ajax({
		type: "GET",
		url: config.Path + '/journalentry/get',
		data: { UserID: _user.ID }
	}).done(function(data){
		HideLoader();
		BuildCompletedJournals(data);
	});
}

function BuildCompletedJournals(data){
	var i = 0;
	var html = '';
	var exists;
	var month = '';
	var journal;
	var date = '';
	var months = [];
	_journals = [];

	for(i=0; i < data.length; i++){
		journal = data[i];
		_journals.push(journal);

		date = moment(journal.JournalDate).format("MMM DD, YYYY");
		month = moment(journal.JournalDate).format("MMMM");

		if(months.indexOf(month)==-1){
			months.push(month);
			html += '<h4 class="journalMonth">' + month + '</h4>';
		}

		html += '<div class="journalRow" id="' + journal.ID + '">';
		html += '<div class="journalName font700 col-xs-12">' + journal.Title + '</div>';
		html += '<div class="row"><div class="journalDate col-xs-4">' + date + '</div>';
		html += '<div class="journalWhat col-xs-4">' + journal.What + '</div>';
		html += '<div class="journalView col-xs-4">View</div></div>';
		html += '</div>';

	} // end for loop

	$('#journalsList').html(html);

	$('.journalRow').off();
	$('.journalRow').on('click', function(){
		_journalIDEditing = $(this).attr('id');
		PopulateJournal();
		MovePageLeft('#pageJournalCreate', _currentPage);
	});
}

function PopulateJournal(){
	var journal = GetJournal(_journalIDEditing);

	var journaldate = moment(journal.JournalDate).format('dddd MMM Do, YYYY');
	$('#todaysDate').html(journaldate);
	$('#journalTitle').val(journal.Title);
	$('#journalText').val(journal.Entry);

	PopulateSmiley(journal.Mood);
	$('#journalWhoTag').val(journal.Who).attr('selected', 'selected');
	$('#journalWhatTag').val(journal.What).attr('selected', 'selected');
}

function PopulateSmiley(smiley){
	ClearSmiley();

	if (smiley !== null && smiley !== '') {
		var clickedSource = $('#'+ smiley).attr('src');
		clickedSource = clickedSource.slice(0, -4);
		clickedSource = clickedSource + '-Red.png';
		$('#'+ smiley).attr('src', clickedSource);
		$('#'+ smiley).addClass('chosenSmiley');
	}
}

function GetJournal(id){
	for(var i = 0; i < _journals.length; i++){
		var j = _journals[i];
		if(j.ID == id){
			return j;
		}
	}

	return null;
}

function SortJournalsWhat(){ //sorting journals by topic
	var what = $('#journalWhatTagSort option:selected').val();
	if(what === ""){
		ShowJournalsWhat();
	} else {
		$('.journalWhat').each(function(){
			if($(this).html() != what){
				$(this).parent().addClass('displayNone');
			}
		});
	}
}

// function ShowJournalsWho(){
// 	$('.journalWho').each(function(){
// 			$(this).parent().removeClass('displayNone');
// 	});
// }

function ShowJournalsWhat(){
	$('.journalWhat').each(function(){
			$(this).parent().removeClass('displayNone');
	});
}

