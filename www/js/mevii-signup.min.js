var newUser = {};
var _paymentInitialized = false;

function InitializeSignup() {
	$('#registerBtn').on('click', function(){
		$('#topLoader').show();
        
        $('body').removeClass('loginBG');
        $('#topLoader').hide();
		MovePageLeft('#pageSignup', _currentPage);
	});

	$('#txtSignupDOB').keyup(function(e){
		if (e.keyCode == 8)
			return;

		var val =$(this).val();
		if (val.length == 2){
			$(this).val(val + '/');
		}
		else if (val.length == 5) {
			$(this).val(val + '/');
		}
	});

	$('#txtSignupFirst, #txtSignupLast').blur(function(){
		var val =$(this).val();
		if (val === ''){
			$(this).addClass('invalid');
		}
		else {
			$(this).removeClass('invalid');
		}
	})

	$('#txtSignupDOB').blur(function(){
		var val =$(this).val();
		if (!ValidateDate(val)){
			$(this).addClass('invalid');
		}
		else {
			$(this).removeClass('invalid');
		}
	});

	$('#txtSignupEmail').blur(function(){
		var val =$(this).val();
		if (!isValidEmailAddress(val)){
			$(this).addClass('invalid');
		}
		else {
			$(this).removeClass('invalid');
		}
	});

    $('#txtSignupConfirmEmail').blur(function(){
        var val =$(this).val();
        if (!isValidEmailAddress(val)){
            $(this).addClass('invalid');
        }
        else {
            $(this).removeClass('invalid');
        }
    });

	$('#btnSignupStart').on('click', function(){
		ValidateStep1(function(isValid){
			if (isValid) {
                $('#signupCodeYes').slideUp(0);
                $('#signupCodeNo').slideUp(0);
                $('#signupCodeAsk').slideDown(0);
                $('#needPayment').slideUp(0);
				MovePageLeft('#pageSignupPayment', _currentPage);
            }
		});
	});

	$('.btnSignupBack').on('click', function(){
		MovePageRight('#pageSignup', _currentPage, function(){
            _discountCode = null;
            
			$('#txtSignupCode').val('');
			$('#signupCodeYes').slideUp(0);
			$('#signupCodeNo').slideUp(0);
			$('#signupCodeAsk').slideDown(0);
            $('#enterCode').slideDown(0);
            $('#needPayment').slideUp(0);
		});
	});

    $('.btnSignupCancel').on('click', function(){
        $('body').addClass('loginBG');
        MovePageRight('#pageHome', _currentPage);
    });

	$('#btnSignupCodeYes').on('click', function(){
		$('#signupCodeAsk').slideUp(300, function(){
			$('#signupCodeYes').slideDown();
			$('#txtSignupCode').focus();
		});
	});

	$('#btnSignupCode').on('click', function(){
		ValidateCode(function(isValid){
			if (!isValid)
				return;

            CodeSignup(function() {
                MovePageLeft("#pageSignupWelcome", _currentPage);
		    });

		});
	});

    $('.btnSignupWelcome').on('click', function(){
        MovePageLeft('#pageSignupDemographics', _currentPage);
    });
    
	$('#btnSignupCodeNo').on('click', function () {
	    $('#signupCodeAsk').slideUp(300, function () {
            InitializeIAP(function(){
                RenderIAP(config.IAP, '#in-app-purchase-list'); // in index.js
                $('#signupCodeNo').slideDown();
            }); // in index.js
	    });
	});

    $('#btnSignupDemographic').on('click', function() {
        ValidateDemographics(function (isValid) {
            $('#btnSignupDemographic').prop('disabled', false);
            
            if (!isValid)
                return;
            
            $('#topLoader').show();
            $.ajax({
                url: config.Path + "/user/saveuser",
                type: 'POST',
                data: _user,
            }).done(function (data) {
                $('#topLoader').hide();
                _user = data;

                $('#btnSignupDemographic').prop('disabled', false);
               
                if (data === null) {
                    HandleError("user/saveuser returned null");
                    return;
                } 
                
                LogInfo("Demographics Saved!");
                ShowFirstPage(data, true);
            });
        });
    });
}

function ValidateCode(callback) {
	var code = $('#txtSignupCode').val();
	if (code === "") {
		LogInfo("User didn't enter a code...");
		ShowError("Please enter the code your employer or insurance company provided");
		callback(false);
		return;
	}

	$('#topLoader').show();

	$.ajax({
		url: config.Path + "/user/validatecode",
		data: { code: code }
	}).done(function(data){
        $('#topLoader').hide();
        
		if (data === null) {
			LogInfo("ERROR : API user/validatecode returned null");
			ShowError("We are sorry, we ran into an issue validating your code.");
			callback(false);
			return;
		}

		if (data == "bad") {
			LogInfo("Buyer code entered was invalid : " + code);
			var html = '<div class="blockError"><h3>Sorry, the access code you provided is either expired or invalid.</h3>';
			html += '<p>Here are a few options:</p>';
			html += '<ul><li>Check the email from your provider and copy/paste your access code.</li>';
			html += '<li>Contact support at <a href="mailto:support@mevii.com">support@mevii.com</a> to get help getting a new access code.</li></ul></div>';

			ShowError(html, true, 15000);
			callback(false);
			return;
		}

        if (data == "good") {
            LogInfo("Code [" + code + "] is valid...moving on.");
            callback(true);
            return;
        }

        LogInfo("Code is a valid for a discount: " + data);

		// need some IAP!
        var lvl = data.substr(data.lastIndexOf(".") + 1);

        var price = '';
        switch (lvl){
            case '99':
                price = '$0.99';
                break;
            case '199':
                price = '$1.99';
                break;
            case '299':
                price = '$2.99';
                break;
            case '399':
                price = '$3.99';
                break;
            case '499':
                price = '$4.99';
                break;
        }

        if (price === 0){
            HandleError('Invalide IAP: ' + data);
            callback(false);
            return;
        }

        InitializeDiscountIAP(data, function() {
            _discountCode = code;

            RenderIAP(data, '#in-app-discount-list'); // in index.js

            $('#enterCode').slideUp(300, function(){
                $('.discountPrice').html(price);
                $('#needPayment').slideDown(300);
				callback(false);
            });
        });
       
	});
}

function ValidateStep1(callback){
    if (config.Debug) {
    	callback(true);
    	return;
    }

	var val = $('#txtSignupFirst').val();
	if (val === ''){
		ShowError('Please tell us your first name.');
		$('#txtSignupFirst').focus();
		callback(false);
		return;
	}

	 val = $('#txtSignupLast').val();
	if (val === ''){
		ShowError('Please tell us your last name.');
		$('#txtSignupLast').focus();
		callback(false);
		return;
	}

    val = $('#txtSignupDOB').val();
	if (!ValidateDate(val)){
		ShowError('Please enter a valid birthday.');
		$('#txtSignupDOB').focus();
		callback(false);
		return;
	}

	var yearsApart = new Date(new Date - new Date(val)).getFullYear()-1970;
	if (yearsApart < 18){
		var html = '<div class="blockError"><h3>You Must Be 18 Years Old to Use Mevii</h3>';
		html += '<p>If you are considering or contemplating suicide or feel that you are a danger to yourself or to others, do NOT use this application. Call the National Suicide Prevention Lifeline, a free, 24-hour hotline, at 800.273.TALK (8255). Your call will be routed to the crisis center near you.</p>';
		html += '<p>In the event of an emergency, immediately call 911 or go to your nearest emergency room. <a target="_blank" href="https://www.mevii.com/resources/">Explore these resources on health and stress management</a> or contact your healthcare provider.</p></div>';
		ShowError(html, true, 20000);
		callback(false);
		$('#txtSignupDOB').focus();
		return;
	}

	var email = $('#txtSignupEmail').val();
	if (!isValidEmailAddress(email)){
		ShowError('Please enter a valid email address.');
		$('#txtSignupEmail').focus();
		callback(false);
		return;
	}

    var confirm = $('#txtSignupConfirmEmail').val();
    if (email != confirm){
        ShowError("Your email addresses do not match.");
        $('#txtSignupEmail').focus();
        callback(false);
        return;
    }
	
	val = $("#txtSignupPassword").val();
	if (val === "") {
	    ShowError("Please enter  password.");
	    $('#txtPassword').focus();
        callback(false);
	    return;
	}

    confirm = $('#txtSignupConfirmPassword').val();
    if (val != confirm){
        ShowError("Your passwords do not match.");
        $('#txtPassword').focus();
        callback(false);
        return;
    }

	$('#topLoader').show();

    $.ajax({
        url: config.Path + '/user/isduplicateemail',
        data: { email: email }
    }).done(function(data) {
        $('#topLoader').hide();

        if (data === null) {
            HandleError('user/isduplicateemail returned null');
            callback(false);
            return;
        }

        if (data === true) {
            ShowError('This email is already in use.');
            $('#txtSignupEmail').focus();
            callback(false);
            return;
        }

        callback(true);
    }); 
}

function CodeSignup(callback) {
    var firstName = $('#txtSignupFirst').val();
    var lastName = $('#txtSignupLast').val();
    var dob = $('#txtSignupDOB').val();
    var email = $('#txtSignupEmail').val();
    var code = $('#txtSignupCode').val();
    
    if (code === "") {
        LogInfo("User didn't enter a code...");
        ShowError("Please enter the code your employer or insurance company provided");
        callback(false);
        return;
    }
    
    var password = $("#txtSignupPassword").val();
    
    newUser = { Email: email, FirstName: firstName, LastName: lastName, DateOfBirth: dob, Password :password, PaymentCode: code };

    $('#topLoader').show();

    $.ajax({
        url: config.Path + "/user/saveuser",
        type: 'POST',
        data: newUser
    }).done(function (data) {
            $('#topLoader').hide();
            if (data === null) {
                LogInfo("Error /user/saveuser");
                ShowError("We are sorry, we ran into an issue validating your code.");
                return;
            }

            if (data.FirstName !== null)
                _user = data;
            
            if (typeof callback != "undefined" && callback != null)
                callback();
    });
}

function DiscountSignup(code, transactionId, receipt, callback) {
    var firstName = $('#txtSignupFirst').val();
    var lastName = $('#txtSignupLast').val();
    var dob = $('#txtSignupDOB').val();
    var email = $('#txtSignupEmail').val();
    var password = $("#txtSignupPassword").val();

    // sometimes the IAP API calls this at a funky time...
    // so if the data isn't right, get out.
    if (firstName === ''){
        if (callback)
            callback(false);

        return;
    }

    LogInfo('Discount Signup! Creating new user with payment. ' + transactionId);
    $('#topLoader').show();
    newUser = { Email: email, FirstName: firstName, LastName: lastName, DateOfBirth: dob, Password: password, PaymentCode: code, IAPTransactionID: transactionId, IAPReceipt: receipt };
 
    $.ajax({
        url: config.Path + "/user/saveuser",
        type: 'POST',
        data: newUser
    }).done(function (data) {
        $('#topLoader').hide();
        if (data === null) {
            HandleError('/user/saveuser returned null');
            return;
        }

        if (data.FirstName !== null){
            LogInfo('Discount User successfully created');
            _user = data;
        }
        else {
            HandleError('Email was a duplicate...that is whack.');
        }

        if (callback)
            callback(true);
    });
}

function ValidateDemographics(callback){
    $('#btnSignupDemographic').prop('disabled', true);
    
    // if (config.Debug) {
    //     callback(true);
    //     return;
    // }

    var zip = $('#txtZip').val();
    var education = $('#ddlEducation').val();
    var employment = $('#ddlEmployment').val();
    var gender = $('#ddlGender').val();
    var reading = $('#ddlReading').val();
    var marital = $('#ddlMarital').val();
    var ethnicity = $('#ddlEthnicity').val();
    var military = $('#ddlMilitary').val();
   
    if (zip === "" || isNaN(zip) || zip.length !== 5){
        ShowError("Please enter a valid 5-digit zip code");
        $('#txtZip').focus();
        callback(false);
        return;
    }

    if (gender == "Select") {
        ShowError("Please select your gender.");
        callback(false);
        return;
    }

    if (ethnicity == "Select") {
        ShowError("Please select your ethnicity.");
        callback(false);
        return;
    }

    if (education == "Select") {
        ShowError("Please select your level of education.");
        callback(false);
        return;
    }

    if (reading == "Select") {
        ShowError("Please select your reading proficiency.");
        callback(false);
        return;
    }

    if (employment == "Select") {
        ShowError("Please select your employment status.");
        callback(false);
        return;
    }

    if (marital == "Select") {
        ShowError("Please select your marital status.");
        callback(false);
        return;
    }

    if (military == "Select") {
        ShowError("Please select your military status.");
        callback(false);
        return;
    }

    _user.Zip = zip;
    _user.EducationLevel = education;
    _user.Employment = employment;
    _user.Gender = gender;
    _user.ReadingHelp = reading;
    _user.MaritalStatus = marital;
    _user.Race = ethnicity;
    _user.MilitaryStatus = military;

    $.ajax({
        url: config.Path + "/user/saveuser",
        type: 'POST',
        data: _user,
    }).done(function (data) {
        _user = data;
        console.log(newUser);
        if (data === null) {
            $('#pageHome').addClass('activePage');
            HideLoadingScreen();
        } else {
            if (data.FirstName == 'EXPIRED') {
                ShowError("We are sorry, your account has expired. Please <a href='https://www.mevii.com/renew' class='errorLink'>click here</a> to renew your subscription.", false);
                return;
            }
        }
         console.log(data.ID);
            ShowFirstPage(data, true);

        LogInfo("Demographics Complete!");
        ShowSuccess("You account is not currently active. Please follow the instructions sent to your email address. If you continue to have trouble, please contact us at <a style='color: #fff' href='mailto:support@mevii.com'>support@mevii.com</a>.");
        if (typeof callback != "undefined" && callback != null)
            callback();
        
    });
}

function PaymentSignup(transactionId, receipt, callback) {
    var firstName = $('#txtSignupFirst').val();
    var lastName = $('#txtSignupLast').val();
    var dob = $('#txtSignupDOB').val();
    var email = $('#txtSignupEmail').val();
    var password = $("#txtSignupPassword").val();

    // sometimes the IAP API calls this at a funky time...
    // so if the data isn't right, get out.
    if (firstName === ''){
        if (callback)
            callback(false);
        
        return;
    }

    LogInfo('Payment Signup! Creating new user with payment. ' + transactionId);
    $('#topLoader').show();
    newUser = { Email: email, FirstName: firstName, LastName: lastName, DateOfBirth: dob, Password: password, IAPTransactionID: transactionId, IAPReceipt: receipt };
 
    $.ajax({
        url: config.Path + "/user/saveuser",
        type: 'POST',
        data: newUser
    }).done(function (data) {
        $('#topLoader').hide();
        if (data === null) {
            HandleError('/user/saveuser returned null');
            return;
        }

        if (data.FirstName !== null){
            LogInfo('User successfully created');
            _user = data;
        }
        else {
            HandleError('Email was a duplicate...that is whack.');
        }

        if (callback)
            callback(true);
    });
}
   
