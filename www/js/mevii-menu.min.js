var _tocLoaded = false;
var _tocStart = null;
var _tipSheets = [];
var _tipSheet = null;
var _tipSheetType = null;

function BuildTipSheetHtml(tipsheets){
	if (tipsheets.length == 0){
		html = '<p>Hmm...nothing to see here.</p>';
	}
	else {
		var prevModule = null;
		var html = '';
		for (var i = 0; i < tipsheets.length; i++) {
			var p = tipsheets[i];
			html += '<div class="tipSheet row pageRow" id="' + p.ID + '">';
			html += '<div class="col-xs-2"><img src="img/assets/iconTipSheets.png" /></div>';
			html += '<div class="col-xs-8 name">' + p.Name + '</div>';
			html += '<div class="col-xs-2"><i class="fa fa-arrow-right"></i></div></div>';
		}
	}

	return html;
}

function ChangePassword(callback){
	if($('#passwordfield1').val() != $('#passwordfield2').val()){
		ShowError("You must enter your new password twice.");
		callback(false);
	}
	else{
		if ($('#passwordfield1').val() === ''){
			callback(true);
		}
		else {
			_user.Password = $('#passwordfield1').val();
			$.ajax({
				url: config.Path + '/user/updatepassword',
				type: 'POST',
				contentType: 'application/json; charset=utf-8',
				data: JSON.stringify(_user)
			}).done(function(data){
				if (data === null){
					HandleError("Update User Password change blew up");
					callback(false);
				}
				else {
					callback(true);
				}
			});
		}

	}
}

function InitializeMenu(){
	$('.dashboard').on('click', function(){
		if ($('#rightMenu').hasClass('activeMenu'))
			return

		_isEmbeddedPA = false;
		_isEmbeddedJournal = false;
		_isEmbeddedMotivation = false;
		_isEmbeddedChangeTool = false;
		_isEmbeddedIC = false;
		_isEmbeddedMatching = false;
		_isEmbeddedPrevisit = false;
		_isEmbeddedResources = false;

		HideToolsMenu();
		ShowDashboardMenu();
	});

	$('#profileSaveAndCancelBtns').hide();

	$('.preferences').on('click', function(){
		if ($("#leftMenu").hasClass('activeMenu')){
			HideSettingsMenu();
			HideSettingsStaticPage('#pageResources');
			HideSettingsStaticPage('#pageTerms');
			HideSettingsStaticPage('#pageHelp');
			HideSettingsStaticPage('#pageStartOver');
			HideSettingsStaticPage('#pageOptOut');
			HideSettingsStaticPage('#pageDeleteAccount');
		}
		HideDashboardMenu('#rightMenu', _currentPage);
		HideToolsMenu();
		ShowSettingsMenu();
	});

	$('#settingsOverlay-close').on('click', function(){
		HideSettingsMenu();
		HideSettingsProfile();
		HideSocialProfile();
		ShowEditProfileButton();
		HidePreferencesProfile();
		HideSettingsStaticPage('#pageResources');
		HideSettingsStaticPage('#pageTerms');
		HideSettingsStaticPage('#pageHelp');
		HideSettingsStaticPage('#pageStartOver');
		HideSettingsStaticPage('#pageOptOut');
		HideSettingsStaticPage('#pageDeleteAccount');
		CloseTrouble();
		CloseDisclaimer();

	});

	$('#settingsHome').on('click', function(){
		if($('#pageContinue').hasClass('activePage')){
			HideSettingsMenu();
		}
		else {
		    LoadContinueProgress(_user.CurrentPageID, function () {
		        var name = _currentModule.Name;
		        var level = name.substr(0, name.indexOf(':'));

		        var progress = $('.marvinBottom .progressBlock');
		        var p = parseInt(_pageOrder / _pageCount * 100);

		        $('#continueModule').html(level);
		        $('#topLoader').hide();
		        $('#loginBtn').prop('disabled', false);

		       // ProcessBackgroundCalls();
		    });
			HideSettingsMenu();
			setTimeout(function(){
				ShowHomePage();
			}, 300);
		}
	});

	$('#settingsProfile').on('click', function(){
		ShowSettingsProfile();
		SetUserProfileInfomation();
	});

	$('#socialProfile').on('click', function(){
		ShowSocialProfile();
		LoadSocialProfile();
	});

	$('.stressRelief').on('click', function() {
		var id = $(this).attr('id');
		if (id == 'stressReliefDashb')
			ShowyClose('#pageStressRelief');
		else
			MovePageLeft('#pageStressRelief', _currentPage);
	});

	$('#btnProfilePageCancel').on('click', function(){
		HideSettingsProfile();
		CloseEditProfile();
		SetUserProfileInfomation();
		ShowEditProfileButton();
	});

	$("#btnProfilePageEdit").on('click', function(){
		OpenEditProfile();
		EditProfile();
		HideEditProfileButton();
	});


	$('#settingsPreferences').on('click', function(){
		ShowPreferencesProfile();
		LoadUserPreferences();
	});

	$('#btnPreferencesCancel').on('click', function(){
		HidePreferencesProfile();
	});
	
	$('#btnPreferencesSave').on('click', function(){
		SavePreferences();
	});

	$('#dashboard_close').on('click', function(){
		HideDashboardMenu('#rightMenu', _currentPage);
	});

	$('#toolsDashb').on('click', function(){
		ShowToolsMenu();
	});

	$('#btnCloseTools').on('click', function(){
		HideToolsMenu();
	});

	$('#journalDashb').on('click', function(){
		LoadCompletedJournals();
		ShowyClose('#pageJournalView');
	});

	$('#calendarDashb').on('click', function(){
		InitializeCalendarEventList('calendarEventsList', function(){
			ShowyClose('#pageCalendarEventView');
		}); // in mevii-calendarevent
	});

	$('#tipsDashb').on('click', function(){
		LoadGenericTipSheets();
		ShowyClose('#pageTipSheet');
	});

	$('#reportsDashb').on('click', function(){
		MovePageLeft('#pageReports', _currentPage);
		HideDashboardMenu();
	});

	$('#btncloseMyPofile').on('click', function () {
	    HideProfile();
	});
	

	$('#tableOfContentsDashb').on('click', function(){
		while (!_tocLoaded) {
			ShowLoader();
		}

		HideLoader();
		ShowyClose('#pageTOC');
	});

	$('#trackersDashb').on('click', function(){
		var time = 300;
		$('body').scrollTop(0);
		$('#tOverlay').fadeIn();
		$('#pageTrackersPopUp').scrollTop(0);
		$('#pageTrackersPopUp').show();
		$('#pageTrackersPopUp').transition({y: '100%'}, 0);
		$('#pageTrackersPopUp').addClass('popup');
		$('#pageTrackersPopUp').transition({y: '0px'}, time, 'linear');
	});

	$('#trackersPopUpFinished').on('click', function(){
		var time = 300;
		$('#tOverlay').fadeOut('fast');
		$('body').scrollTop(0);
		$('#pageTrackersPopUp').transition({y: '100%'}, time, 'linear');
		setTimeout(function(){
			$('.page').removeClass('popup');
			$('#pageTrackersPopUp').hide();
		  }, time);
	});

	$('#askMeviiDashb, #btnWatson').on('click', function(){
		StartWatson();
    });

	$('#libraryDashb').on('click', function(){
		MovePageLeft('#pageLibrary', _currentPage);
		HideDashboardMenu();
	});

	$('#favDashb').on('click', function(){
		ShowyClose('#pageFavs');
	});

	$('#innerCirDashb').on('click', function(){
		LoadInnerCircle();
		LoadMutualSupport();
		ShowyClose('#pageInnerCircle');
	});

	$('#settingsLogout').on('click', function(){
		Logout();
	});

	$('#settingsClose').on('click', function () {
	    HideSettingsMenu();
	});

	$('#btnContinuePleasant').on('click', function () {
	
		$.ajax({
			url: config.Path + '/user/updatestatistics',
			data: { UserID: _user.ID, PleasantActivityHomeClicks: 1 },
			type: 'POST'
		}).done(function(data){
			if (data === null)
				HandleError('/user/updatestatistics returned null');
		});
		LoadPleasantActivitiesIdeas();
		LoadPleasantActivities(function(){
			MovePageLeft('#pagePleasantHome', _currentPage);
		});
	});

	$('.logo').on('click', function(){
		ShowHomePage();
	});
	$('#settingsResources').on('click', function(){
		ShowSettingsStaticPage('Resources', '#pageResources');
	});
	$('#settingsHelp').on('click', function(){
		ShowSettingsStaticPage('Help', '#pageHelp');
	});
	$('#settingsTerms').on('click', function(){
		ShowSettingsStaticPage('Terms', '#pageTerms');
	});
	$('#pageResourcesCancel').on('click', function(){
		HideSettingsStaticPage('#pageResources');
	});
	$('#pageTermsCancel').on('click', function(){
		HideSettingsStaticPage('#pageTerms');
	});
	$('#pageHelpCancel').on('click', function(){
		HideSettingsStaticPage('#pageHelp');
	});
	$('#assertiveToolBtn').on('click', function(){
		ShowOpportunities();
		ShowyClose('#pageAssertive');
	});

	$('#btnStartOver').on('click', function(){
		ShowSettingsStaticPage('Start Over', '#pageStartOver');
	});
	$('#btnOptOut').on('click', function(){
		ShowSettingsStaticPage('Opt Out of Program', '#pageOptOut');
		HideSettingsStaticPage('#pageTerms');
	});
	$('#btnDeleteAcct').on('click', function(){
		ShowSettingsStaticPage('Delete Account', '#pageDeleteAccount');
	});
	$('.confirmCancel').on('click', function(){
		HideSettingsStaticPage('#pageStartOver');
		HideSettingsStaticPage('#pageOptOut');
		HideSettingsStaticPage('#pageDeleteAccount');
	});
	$('#startAgainYes').on('click', function(){
		StartProgramOver();
	});
}

function LoadMenuInfo(){
	$.ajax({
		url: config.Path + '/marvin/gettableofcontents',
		data: { userID: _user.ID }
	}).done(function(data){
		_tocLoaded = true;

		if (data === null){
			HandleError('Table of contents came back null...');
			return;
		}

		BuildTOC(data);
	});

	$.ajax({
		url: config.Path + '/marvin/gettipsheets'
	}).done(function(data){
		_tocLoaded = true;

		if (data === null){
			HandleError('Tip Sheets back null...');
			return;
		}

		_tipSheets = data;
	});
}

function BuildTOC(pages){
	var html= '';
	var prevModule = null;
	for (var i = 0; i < pages.length; i++) {
		var p = pages[i];
		if (p.Module.Name != prevModule){
			var name = p.Module.Name;
			var ID = p.Module.ID;
			var sub = name.split(":");
			var isLocked = p.Module.IsLocked;

			// alert(sub);
			html += '<div class="tocModule pageRow" id="' + ID + '" data-lock="' + isLocked + '">';
			html += '<div class="row ';

			if (isLocked)
				html += 'moduleLocked';

			html += '"><div class="moduleNumber col-xs-12">'+ sub[0] +':</div></div>';
			html += '<div class="row ';

			if (isLocked)
				html += 'moduleLocked';

			html += '"><div class="col-xs-10 moduleTitle"><div class="title">' + sub[1] + '</div></div>';
			html += '<div class="col-xs-2"><i class="fa fa-arrow-right"></i></div></div></div>';
			prevModule = name;
		}
	}

	$('#tocWrapper').html(html);
	$('.tocModule').on('click', function(){
		var moduleID = $(this).attr('id');
		var isLocked = $(this).data('lock');

		if (isLocked === true)
			return;

		var moduleTitle = $(this).text();
		var sub = moduleTitle.split(":");

		html = '<div class="row"><div class="col-xs-12 level">'+ sub[0] +'</div></div>';
		html += '<div class="row"><div class="col-xs-12 levelTitle">' + sub[1] + '</div></div>';

		for (var i = 0; i < pages.length; i++) {
			var p = pages[i];

			if (p.Module.ID != moduleID)
				continue;

			if (p.BuyerID !== null){
				if (_buyer === null)
					continue;

				if (_buyer.ID != p.BuyerID)
					continue;
			}

			var name = p.Name;
			var ID = p.ID;
			//alert(p.Module.Name);
			html += '<div class="row tocQuestPage" data-id="'+ID+'">';
			html += '<div class="col-xs-10 "><div class="tocPageName" >' + name + '</div></div>';
			html += '<div class="col-xs-2"><i class="fa fa-arrow-right"></i></div></div>';
		}

		html += '<div class="btnPrevTOC"><i class="fa fa-caret-left"></i>Back</div>';

		$('#tocModuleWrapper').html(html);
		MovePageLeft('#pageTOCModule', _currentPage);

		$('.btnPrevTOC').on('click', function(){
			MovePageRight('#pageTOC', _currentPage);
		});

		$('.tocQuestPage').on('click', function(){
			Reset();
			var ID = $(this).data("id");
			_tocStart = ID;
			_user.CurrentPageID = ID;
			Continue(ID, true); // in content-engine
		});
	});
}

function LoadGenericTipSheets() {
	var generic = [];
	for (var i = 0; i < _tipSheets.length; i++) {
		var ts = _tipSheets[i];
		if (ts.OnGenericTipSheet)
			generic.push(ts);
	}

	var html = BuildTipSheetHtml(generic);

	$('#genericTipSheetWrapper').html(html);

	$('.tipSheet').off();
	$('.tipSheet').on('click', function() {
		var pageID = $(this).attr('id');
		ShowTipSheet(pageID, 'generic');
	});
}

function LoadStressTipSheets(){
	var stress = [];
	for (var i = 0; i < _tipSheets.length; i++) {
		var ts = _tipSheets[i];
		if (ts.OnStressTipSheet)
			stress.push(ts);
	}

	var html = BuildTipSheetHtml(stress);

	$('#stressTipSheetWrapper').html(html);

	$('.tipSheet').off();
	$('.tipSheet').on('click', function(){
		var pageID = $(this).attr('id');
		ShowTipSheet(pageID, 'stress');
	});
}

function Logout(){
	HideSettingsMenu();
	window.localStorage.removeItem('meviiSession');
	_user = null;

	setTimeout(function(){
		HideHeader();
		$('body').addClass('loginBG');
		MovePageRight('#pageHome', _currentPage);
	}, 300);
}
function HideDashboardMenu(){
   var time = 400;
	HideSettingsProfile();
	HidePreferencesProfile();
	HideSocialProfile();
	var menu = $('#rightMenu');
	menu.transition({x: '100%'}, time);
	setTimeout(function(){
	   $("body").removeClass('noScroll');
		menu.removeClass('activeMenu');
		menu.hide();
	}, time);
}
function ShowDashboardMenu(){
	var time = 500;
	$('body').scrollTop(0);
	$("body").addClass('noScroll');
	var menu = $('#rightMenu');
	$('.menu').removeClass('activeMenu');
	menu.show();
	menu.addClass('activeMenu');
	menu.transition({x: '100%'}, 0);
	menu.transition({x: '0'}, time, 'linear');
}
function HideSettingsMenu(){
	var time = 400;
	var menu = $('#leftMenu');
	menu.transition({x: '-100%'}, time);
	$('#settingsOverlay-close').css('background-color', '');
	setTimeout(function(){
	   $("body").removeClass('noScroll');
		menu.removeClass('activeMenu');
		menu.hide();
	}, time);
}
function ShowSettingsMenu(){
	var time = 500;
	$('body').scrollTop(0);
	$('#settingsOverlay-close').css('background-color', '');
	var menu = $('#leftMenu');
	$('.menu').removeClass('activeMenu');
	menu.show();
	menu.addClass('activeMenu');
	menu.transition({x: '-100%'}, 0);
	menu.transition({x: '0'}, time, 'linear');
	$('#leftMenuHeaderText').text("Settings");
	setTimeout(function(){
		$('#settingsOverlay-close').css('background-color', 'rgba(0,0,0,.7)');
		$("body").addClass('noScroll');
	}, time);
}
function HideToolsMenu(){
	var time = 300;
	var menu = $('#pageTools');
	menu.transition({x: '100%'}, time);
	 $('#dashboard_close').show();
	setTimeout(function(){
		//menu.removeClass('activeMenu');
		menu.hide();

	}, time);
}

function ShowHomePage(){
	Reset();
	
	ShowLoader();
	LoadMessages(function(){
		HideLoader();
		MovePageRight('#pageContinue', _currentPage);
	});
}

function ShowToolsMenu(){
	var time = 500;
	$('body').scrollTop(0);
	var menu = $('#pageTools');
	menu.show();
	menu.transition({x: '100%'}, 0);
	menu.transition({x: '0'}, time, 'linear');
	$('#dashboard_close').hide();
}

function ShowyClose(to, callback){
	HideDashboardMenu();
	HideToolsMenu();
	setTimeout(function(){
		MovePageLeft(to, _currentPage, function(){
			if (callback){
				callback();
			}
		});
	}, 400);
}

function HidePreferencesProfile(){
	var time = 300;

	$('#leftMenuHeaderText').text("Settings");
	var menu = $('#pagePreferences');
	menu.transition({x: '-100%'}, time);
	setTimeout(function(){
		menu.removeClass('activeSetting');
		menu.hide();
	}, time);
}
function ShowPreferencesProfile(){
	var time = 500;

	$('#leftMenuHeaderText').text("My Preferences");
	var menu = $('#pagePreferences');
	menu.show();
	menu.addClass('activeSetting');
	menu.transition({x: '-100%'}, 0);
	menu.transition({x: '0'}, time, 'linear');
}
function HideSettingsProfile(){
	var time = 300;
	$('#leftMenuHeaderText').text("Settings");
	var menu = $('#pageProfile');
	menu.transition({x: '-100%'}, time);
	setTimeout(function(){
		menu.removeClass('activeSetting');
		menu.hide();
	}, time);
}
function ShowSettingsProfile(){
	var time = 500;
	// $('#btnProfilePageSave').off();
	$('#leftMenuHeaderText').text("My Profile");
	var menu = $('#pageProfile');
	menu.show();
	menu.addClass('activeSetting');
	menu.transition({x: '-100%'}, 0);
	menu.transition({x: '0'}, time, 'linear');
}
function ShowSocialProfile(){
	var time = 500;
	$('#leftMenuHeaderText').text("Social Profile");
	var menu = $('#pageSocialProfile');
	menu.show();
	menu.addClass('activeSetting');
	menu.transition({x: '-100%'}, 0);
	menu.transition({x: '0'}, time, 'linear');
}
function HideSocialProfile(){
	var time = 300;
	$('#leftMenuHeaderText').text("Settings");
	var menu = $('#pageSocialProfile');
	menu.transition({x: '-100%'}, time);
	setTimeout(function(){
		menu.removeClass('activeSetting');
		menu.hide();
	}, time);
}
function SetUserProfileInfomation(){
	$('.userName').html(_user.FirstName);
	$('.userLastName').html(_user.LastName);
	$('.userEmail').html(_user.Email);
	$('.userPhone').html(_user.MobilePhone);
	$('.userZipCode').html(_user.Zip);

	if (_user.Gender == 1)
		$('.userGender').html('Female');
	else {
		$('.userGender').html('Male');
	}
}

function OpenEditProfile(){
	$('#hiddenEditPassword').slideDown(500, function(){
		$('#hiddenEditPassword').css('display', 'initial');
	});
}
function EditProfile(){
	$('#passwordfield1').val('');
	$('#passwordfield2').val('');
	$('#profilePageFirstName').html('<input type="text" id="firstNameInput" />');
	$('#firstNameInput').val(_user.FirstName);
	$('#profilePageLastName').html('<input type="text" id="lastNameInput" />');
	$('#lastNameInput').val(_user.LastName);
	$('#profilePageEmail').html('<input type="text" id="emailInput" />');
	$('#emailInput').val(_user.Email);
	$('#profilePagePhone').html('<input type="text" id="phoneInput" />');
	$('#phoneInput').val(_user.MobilePhone);
	$('#profilePageZipCode').html('<input type="text" id="zipCodeInput" />');
	$('#zipCodeInput').val(_user.Zip);
	$('#profilePageGender').html('<select id="genderInput" class="form-control"><option value="1">Female</option><option value="2">Male</option></select>');
	$('#genderInput').val(_user.Gender);

	$('#btnProfilePageSave').off();
	$('#btnProfilePageSave').on('click', function(){
		//Saves, validates, and closes the edit menu if pw is valid
		SaveProfileSettings(function(isSuccess){
			if (!isSuccess)
				return;

			ChangePassword(function(isSuccess){
				if (!isSuccess)
					return;

				CloseEditProfile();
				HideSettingsProfile();
				ShowSuccess("User Saved.");
				HideLoader();
				ShowEditProfileButton();
			});
		});
	});
	$("#phoneInput").mask("(999) 999-9999");
}
function HideEditProfileButton(){
	$('#ProfileButtonDiv').hide();
	$('#btnStartOver').hide();
	$('#btnDeleteAcct').hide();
	$('#profileSaveAndCancelBtns').show();
}
function ShowEditProfileButton(){
	$('#ProfileButtonDiv').show();
	$('#btnStartOver').show();
	$('#btnDeleteAcct').show();
	$('#profileSaveAndCancelBtns').hide();

}

function CloseEditProfile(){
	$('#hiddenEditPassword').slideUp(300, function(){
		$('#hiddenEditPassword').css('display', 'none');
	});
	// $('#btnProfilePageSave').off();
}
function SaveProfileSettings(callback){
	var first = $('#firstNameInput').val();
	var last = $('#lastNameInput').val();
	var email = $('#emailInput').val();
	var phone = $('#phoneInput').val();
	var zip = $('#zipCodeInput').val();
	var gender = $('#genderInput').val();

	if (first === ''){
		ShowError("Please enter your first name");
		$('#firstNameInput').focus();
		callback(false);
	}

	if (last === ''){
		ShowError("Please enter your last name");
		$('#lastNameInput').focus();
		callback(false);
		return;
	}

	var checkEmail = isValidEmailAddress(email);
	if (!checkEmail){
		$('#emailInput').focus();
		ShowError("Please enter a valid email address");
		callback(false);
		return;
	}

	if (zip === "" || isNaN(zip) || zip.length !== 5){
		ShowError("Please enter a valid 5-digit zip code");
		$('#zipCodeInput').focus();
		callback(false);
		return;
	}

	if (phone === "" || !ValidatePhoneNumber(phone)){
		ShowError("Please enter a valid phone number.");
		$('#phoneInput').focus();
		callback(false);
		return;
	}

	_user.FirstName = first;
	_user.LastName = last;
	_user.Email = email;
	_user.MobilePhone = phone;
	_user.Zip = zip;
	_user.Gender = gender;

	$.ajax({
		url: config.Path + '/user/saveuser',
		type: 'POST',
		contentType: 'application/json; charset=utf-8',
		data: JSON.stringify(_user)
	}).done(function(data){
		if (data === null){
			HandleError("SaveProfileSettings went blew up");
			callback(false);
		}

		callback(true);
	});
}

function ShowSettingsStaticPage(pageTitle, pageID){
	var time = 500;

	$('#leftMenuHeaderText').text(pageTitle);
	var menu = $(pageID);
	menu.show();
	menu.addClass('activeSetting');
	menu.transition({x: '-100%'}, 0);
	menu.transition({x: '0'}, time, 'linear');

}
function HideSettingsStaticPage(pageID){
	var time = 300;

	$('#leftMenuHeaderText').text("Settings");
	var menu = $(pageID);
	menu.transition({x: '-100%'}, time);
	setTimeout(function(){

		menu.removeClass('activeSetting');
		menu.hide();
	}, time);
}

function HideProfile() {
    var time = 300;

    $('#leftMenuHeaderText').text("Settings");
    var menu = $('#pageProfile');
    menu.transition({ x: '-100%' }, time);
    setTimeout(function () {
        menu.removeClass('activeSetting');
        menu.hide();
    }, time);
}

function StartProgramOver(){
	$.ajax({
		url: config.Path + '/user/startover',
		type: 'POST',
		contentType: 'application/json; charset=utf-8',
		data: JSON.stringify(_user)
	}).done(function(data){
		if (data === null){
			HandleError("Start program over blew up");
			return;
		}
		else{
			HideSettingsMenu();
			HideSettingsProfile();
			HideSettingsStaticPage('#pageStartOver');
			ShowHomePage();
			ShowSuccess(" Program Started over.");
		}
	});
}


