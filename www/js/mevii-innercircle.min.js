var _mutualSupportID = '';
var _mutualSupport = '';

function InitializeInnerCircle(){

	$('#addHappyMomentsContactBtn').on('click', function(){
		ShowPartial('#happyMomentsAddContacts');
	});
	$('#addGlassHalfFullContactsBtn').on('click', function(){
		ShowPartial('#glassHalfFullAddContacts');
	});
	$('#addAlwaysSupportiveContactsBtn').on('click', function(){
		ShowPartial('#alwaysSupportiveAddContacts');
	});
	$('#addEmotionalSupportContactBtn').on('click', function(){
		ShowPartial('#emotionalSupportAddContacts');
	});
	$('#addInformationalSupprtContactBtn').on('click', function(){
		ShowPartial('#informationalSupportAddContacts');
	});
	$('#addTangibleSupportContactBtn').on('click', function(){
		ShowPartial('#tangibleSupportAddContacts');
	});
	$('#btnSaveMutualSupport').on('click', function(){
	    SaveMutualSupport();
	    if (_isEmbeddedIC) {
	        _isEmbeddedIC = false;
	        ShowNextPage(); // in contentengine...
	    }
	    else
		ShowHomePage();
	});
	$('#btnCloseInnerCircle').on('click', function(){
		if (_isEmbeddedIC){
			_isEmbeddedIC = false;
			ShowNextPage(); // in contentengine...
		}
		else
			ShowHomePage();
	});
}

function LoadInnerCircle(callback){
	ShowLoader();

	$.ajax({
			type: 'GET',
			url: config.Path + '/innercircle/gettool',
			data: {userID: _user.ID}
		}).done(function(data){
			if (data === null)
				HandleError('innercircle/gettool returned null...');
			else {//alert(JSON.stringify(data));
				$('.innerCircleList').html('');
				for (var i = 0; i < data.length; i++){
					var html = '';
					var contactType = data[i].Type;
					var contactName = data[i].Name;
					var contactPhone = formatPhoneNumber(data[i].Phone);
					var contactEmail = data[i].Email;
					var contactID = data[i].ID;

					if(contactPhone===null || contactPhone == "null"){
						contactPhone = "";
					}

					if(contactEmail===null || contactEmail=="null"){
						contactEmail = "";
					}

					html = '<div class="listParent"><div class="icDisplay"><div class="col-xs-8 innerListName">'+ contactName + '</div>';
					html += '<div class="innerListEdit col-xs-4"><div><span class = "theEditButton font300">Edit</span></div></div>';
					html += '<div class="col-xs-12 innerListPhone"><a href="tel:' + contactPhone + '">' + contactPhone + '</a></div>';
					html += '<div class="col-xs-12 innerListEmail"><a href="mailto:' + contactEmail + '">' + contactEmail + '</a></div></div>';
					
					html += '<input type="hidden" class="hiddenInnerCircleClass" value="' + contactID + '" /></div>';

					if (contactType == 'Happy Moments'){
						$('#happyMomentsListContacts').append(html);
					}
					else if (contactType == 'Glass Half Full'){
						$('#glassHalfFullListContacts').append(html);
					}
					else if (contactType == 'Always Supportive'){
						$('#alwaysSupportiveListContacts').append(html);
					}
					else if (contactType == 'Emotional Support'){
						$('#emotionalSupportListContacts').append(html);
					}
					else if (contactType == 'Informational Support'){
						$('#informationalSupportListContacts').append(html);
					}
					else if (contactType == 'Tangible Support'){
						$('#tangibleSupportListContacts').append(html);
					}

				}

				$('.theEditButton').on('click', function(){
					var parent = $(this).closest('.listParent');
					var theID = parent.find(".hiddenInnerCircleClass").val();
					//figure out how to select the specific contact you need to edit. Try grabbing the ID out of
					//hidden ID field
					parent.find('.icDisplay').hide();
					
					$('.deleteInnerCircleContact').css('display', '');

					var name = parent.find('.innerListName').text();
					var phone = parent.find('.innerListPhone').text();
					var email = parent.find('.innerListEmail').text();

					// alert(theID);
					ShowEditPartial(parent, theID);


					$('.innerCircleName').val(name);
					$('.innerCirclePhone').val(phone);
					$('.innerCircleEmail').val(email);
					$('#hiddenInnerCircleID').val(theID);
					

				});

				HideLoader();
			}
	});
}
function ShowEditPartial(id, theID){
	
	 var partialHtml= $('#partialAddInnerCircle').html();
	 $(id).html(partialHtml);
	 $('.editButtons').css('display', 'none');
	 $('.cancelInnerCircleContact').on('click', function(){
	 	HideEditPartial(id);
	 });
	 $('.saveInnerCircleContact').on('click', function(){

	 	var editedName = $('.innerCircleName').val();
	 	var editedPhone = $('.innerCirclePhone').val();
		var editedEmail = $('.innerCircleEmail').val();
		var parent = $(this).closest('.listParent');
		// var theID = $('.hiddenInnerCircleClass').val();
		var correctID = theID;

		var editedInnerCircleData = {userID: _user.ID, ID: correctID, name: editedName, phone: editedPhone, email: editedEmail}

		if(!editedName){
			ShowError("Please enter a name or press Cancel.");
			return;
		}
		if(editedEmail){
			var emailTest = isValidEmailAddress(editedEmail);
			if(!emailTest) { 
				ShowError("Please enter a valid email address.");
			return;
			}
		}

		HidePartial();

		ShowLoader();
		$.ajax({
			type:"POST",
			url: config.Path + '/innercircle/savetool',
			data: editedInnerCircleData
		}).done(function(data){
			if (data === null)
				HandleError("Inner Circle save encountered a problem. Try again.");
			else{
				ShowSuccess('Inner Circle saved.')
				LoadInnerCircle();
			}

		});

	 	HideEditPartial(id);

	});
	$('.deleteInnerCircleContact').on('click', function(){
	 	
	 	var innerEditClass = $(this).parent().parent().parent().parent();
	 	var hiddenId = $('#hiddenInnerCircleID').val();
	 	
	 	$.ajax({
			type:"POST",
			url: config.Path + '/innercircle/deletetool',
			data: {ID: hiddenId}
		}).done(function(data){
			if (data === null)
				HandleError("Inner Circle delete encountered a problem. Try again.");
			else{
				ShowSuccess('Contact deleted.');
				LoadInnerCircle();
			}
	 	});
		HideEditPartial(id);
	});
}
function ShowPartial(id){

	var partialHtml= $('#partialAddInnerCircle').html();
	$(id).html(partialHtml);
	$('.editButtons').css('display', 'none');
	$(id).slideDown();
	$(id + ' .cancelInnerCircleContact').on('click', function(){
		HidePartial();
	});
	$('.saveInnerCircleContact').on('click', function(){
		SaveContactToInnerCircle(id);
		// HidePartial();
	});
}

function HidePartial(){
	$('.innerCircleAddWrapper').slideUp('fast', function(){
		$('.innerCircleAddWrapper').html('');
		$('.editButtons').css('display', '');
	});
}
function HideEditPartial(id){
	LoadInnerCircle();
	$(id).slideUp(function(){
		//$('.innerCircleList').html('');
		$('.editButtons').css('display', '');
	});
}

function SaveContactToInnerCircle(theID){
	var addName = $(theID + ' .innerCircleName').val();
	var addPhone = $(theID + ' .innerCirclePhone').val();
	var addEmail = $(theID + ' .innerCircleEmail').val();
	var addType = $(theID).data("type");

	var InnerCircleData = {userID: _user.ID, type: addType , name: addName , phone: addPhone , email: addEmail}

	if(!addName){
		ShowError("Please enter a name or press Cancel.");
		return;
	}
	if(addEmail){
		var emailTest = isValidEmailAddress(addEmail);
		if(!emailTest) { 
			ShowError("Please enter a valid email address.");
		return;
		}
	}

	HidePartial();

	$.ajax({
		type:"POST",
		url: config.Path + '/innercircle/savetool',
		data: InnerCircleData
	}).done(function(data){
		if (data === null)
			HandleError("Inner Circle save encountered a problem. Please try again.");
		else{
			LoadInnerCircle();
		}
	});
}

function LoadMutualSupport(){
	
	$.ajax({ 
			type: 'GET',
			url: config.Path + '/innercircle/getsupport',
			data: {userID: _user.ID}
		}).done(function(data){
			if (data === null)
				HandleError('innercircle/getsupport returned null...');
			else {
				_mutualSupport = data.MutualSupport;
				_mutualSupportID = data.ID;
				if (_mutualSupport === null){
					$('#mutualSupport').val("");
				}
				else if (_mutualSupport !== null){
					$('#mutualSupport').val(_mutualSupport);
				}
			}
		});

}
function SaveMutualSupport(){
	if (_mutualSupport === null){

		_mutualSupport = $('#mutualSupport').val();
		$.ajax({ 
				type: 'POST',
				url: config.Path + '/innercircle/savesupport',
				data: {MutualSupport: _mutualSupport ,userID: _user.ID}
			}).done(function(data){
				if (data === null)
					HandleError('innercircle/savesupport returned null...');
				else {
					//alert(JSON.stringify(data));
					ShowSuccess("Inncer Circle tool saved.");
					_mutualSupportID = data.ID;
				}
			});
	}
	else{
		_mutualSupport = $('#mutualSupport').val();
		$.ajax({ 
				type: 'POST',
				url: config.Path + '/innercircle/savesupport',
				data: {ID: _mutualSupportID, MutualSupport: _mutualSupport ,userID: _user.ID}
			}).done(function(data){
				if (data === null){
					HandleError('innercircle/savesupport returned null...');
				} else {
					ShowSuccess("Inncer Circle tool saved.");
				}
			});
	}

}


function formatPhoneNumber(s) {
  	var s2 = (""+s).replace(/\D/g, '');
  	var m = s2.match(/^(\d{3})(\d{3})(\d{4})$/);
  	return (!m) ? null : "(" + m[1] + ") " + m[2] + "-" + m[3];
}

