var _eventID = null;
var _thoughtID = null;
var _actionID = null;
var _positiveActionID = null;

var _allEventsStorage = [];
var _positiveActionStorage = [];

var _howDidIFeelPopup = [];
var _howThoughtsFeelPopup = [];
var _howWantFeelPopup = [];

var _isEditingFeelings = false;
var _isEditingThought = false;
var _isEditingAction = false;
var _isEditingPositiveAction = false;
var _isSearching = false;

var _previousFeelingsPage = "";

function InitializeFeelings(){

	$('#feelingsToolBtn').on('click', function(){
		// ShowyClose('#pageLearningFeelings');
		_isEditingFeelings = false;
		$('.eventsHomeMenuBtn').addClass('active');
        $('.eventsSearchMenuBtn').removeClass('active');
        $('.eventsNewMenuBtn').removeClass('active');
		ShowyClose('#pageFeelingsEventsHome');
		GetEvents();
	});

	$('.eventsHomeMenuBtn').on('click', function(){
		_isSearching = false;

		ShowLoader();
		GetEvents(function(){
			MovePageRight('#pageFeelingsEventsHome', _currentPage);
			$('.eventsHomeMenuBtn').addClass('active');
			$('.eventsSearchMenuBtn').removeClass('active');
			$('.eventsNewMenuBtn').removeClass('active');
			HideLoader();
		})

	});

	$('#btnFeelingEmbedDone').on('click', function(){
		ShowNextPage(); // in contentengine...
		_isEmbeddedChangeTool = false;
	});

	$('.eventsNewMenuBtn').on('click', function(){
		StartNewEvent();
		MovePageLeft('#pageFeelingsNewEventPage', _currentPage);
	});

	$('.eventsSearchMenuBtn').on('click', function(){
		_isSearching = true;
		$('#eventSearchResults').html('');

		MovePageLeft('#pageFeelingsSearch', _currentPage);
		$('.eventsHomeMenuBtn').removeClass('active');
        $('.eventsSearchMenuBtn').addClass('active');
        $('.eventsNewMenuBtn').removeClass('active');
	});

	$('#feelingsSummaryDoneBtn').on('click', function(){
		_isEditingFeelings = false;
		ClearSummaryPage();
		MovePageRight(_previousFeelingsPage, _currentPage);
		if(_previousFeelingsPage=='#pageFeelingsSearch'){
			$('.eventsHomeMenuBtn').removeClass('active');
	        $('.eventsSearchMenuBtn').addClass('active');
	        $('.eventsNewMenuBtn').removeClass('active');
		} else {
			$('.eventsHomeMenuBtn').addClass('active');
        	$('.eventsSearchMenuBtn').removeClass('active');
        	$('.eventsNewMenuBtn').removeClass('active');
		}
	});

	$('#goToFeelingsBtn').on('click', function(){
		SetupEditFeelings();
		MovePageLeft("#pageLearningFeelings", _currentPage);
	});

	$('#goToThoughtsBtn').on('click', function(){
		SetupEditThoughts();
		MovePageLeft("#pageWhatDidIThinkFeelings", _currentPage);
	});

	$('#goToActionsBtn').on('click', function(){
		SetupEditActions();
		MovePageLeft("#pageWhatDidIDoFeelings", _currentPage);
	});

	$('#goToSummaryBtn').on('click', function(){
		GetEvents();
		// var e = GetEventFromStorage(_eventID);
		EditCompletedEvent(_allEventsStorage);

		_previousFeelingsPage = _currentPage;
		MovePageLeft('#pageFeelingsSummary', _currentPage);
	});

	$('#feelingsLearningBackBtn').on('click', function(){
		ClearFeelingsForm();
		GetEvents();
		EditCompletedEvent(_allEventsStorage);
		if(_isEditingFeelings === true){
			MovePageRight('#pageFeelingsSummary', _currentPage);
			return;
		}
		MovePageRight('#pageFeelingsNewEventPage', _currentPage);
	});

	$('#btnEventDone').on('click', function(){
		ResetFeelingsTool();

		if (_isSearching)
			MovePageRight('#pageFeelingsSearch', _currentPage);
		else
			MovePageRight('#pageFeelingsEventsHome', _currentPage);
	});

	$('#feelingsNextBtn').on('click', function(){
		GatherDataFromAddEventsPage();
		// MovePageLeft('#pageWhatDidIDoFeelings', _currentPage); // remove/comment out after testing
	});

	$('#addFeelingBtn').on('click', function(){
		MovePageUp('#pageHowDidIFeelPopUp', '#pageLearningFeelings');

		$('#howDidIFeelPopUpFinished').on('click', function(){
			GatherHowDidIFeelPopupData();
			MovePageDown('#pageLearningFeelings', '#pageHowDidIFeelPopUp');
		});

		$('#howDidIFeelPopUpCancel').on('click', function(){
			MovePageDown('#pageLearningFeelings', '#pageHowDidIFeelPopUp');
		});
	});

	$('#thinkAddFeelingBtn').on('click', function(){ // Popup
		MovePageUp('#pageHowThoughtsFeelPopUp', '#pageChallengeTheThoughtFeelings');

		$('#howThoughtsFeelPopUpFinished').on('click', function(){	//close PopUp
			GatherHowThoughtsFeelPopUpData();
		});

		$('#howThoughtsFeelPopUpCancel').on('click', function(){
			MovePageDown('#pageChallengeTheThoughtFeelings', '#pageHowThoughtsFeelPopUp');
		});
	});

	$('#thinkWantToFeelBtn').on('click', function(){ // Popup
		MovePageUp('#pageHowIWantToFeelPopUp', '#pageChallengeTheThoughtFeelings');

		$('#wantFeelPopUpFinished').on('click', function(){	//close PopUp
			GatherWantFeelPopUpData();
		});

		$('#wantFeelPopUpCancel').on('click', function(){
			MovePageDown('#pageChallengeTheThoughtFeelings', '#pageHowIWantToFeelPopUp');
		});
	});

	$('#feelingsAddNewActionBtn').on('click', function(){
		$('#whatDidIDoForm').removeClass('displayNone');;
		$('#feelingsAddNewActionBtn').addClass('displayNone');

	});

	$('#feelingsMyActionsNextBtn').on('click', function(){
		GatherDataFromWhatDidIDoPage();
		// MovePageLeft('#pageChallengeTheThoughtFeelings', _currentPage); // remove/comment out after testing
	});

	$('#feelingsMyActionsBackBtn').on('click', function(){
		GetEvents();
		EditCompletedEvent(_allEventsStorage);
		if(_isEditingFeelings==true){
			MovePageRight('#pageFeelingsSummary', _currentPage);
			ClearActionsForm();
			return;
		}
		MovePageRight('#pageFeelingsNewEventPage', _currentPage);
	});

	$('#feelingsWhatIThinkBackBtn').on('click', function(){
		MovePageRight('#pageFeelingsNewEventPage', _currentPage);
	});

	$('#feelingsWhatIThinkNextBtn').on('click', function(){
		// BuildSummaryPage();
		MovePageLeft('#pageChallengeTheThoughtFeelings', _currentPage);
	});

	$('#saveThoughtsBtn').on('click', function(){
		SaveThought();
	});

	$('#cancelThoughtsBtn').on('click', function(){
		$('#newThoughtText').val('');
		$('#newThoughtPositive').prop('checked', false);
		$('#newThoughtNegative').prop('checked', false);
		_isEditingThought = false;
		_thoughtID = null;
		$('#newThoughtsForm').addClass('displayNone');
		$('#addNewThoughtBtn').removeClass('displayNone');
	});

	PositiveOrNegativeCheckboxes();
	AssumptionCheckboxes();
	ActionsPositiveOrNegativeCheckboxes();

	$('#addNewThoughtBtn').on('click', function(){
		$('#newThoughtsForm').removeClass('displayNone');
		$('#addNewThoughtBtn').addClass('displayNone');
	});

	$('#thoughtsDoneBtn').on('click', function(){
		GetEvents();
		EditCompletedEvent(_allEventsStorage);
		ClearThoughtsForm();
		if(_isEditingFeelings === true){
			MovePageRight('#pageFeelingsSummary', _currentPage);
			return;
		}
		MovePageRight('#pageFeelingsNewEventPage', _currentPage);
	});

	$('#saveChallengeThoughtBtn').on('click', function(){
		SaveChallengeThought();
	});

	$('#challengeThoughtCancelBtn').on('click', function(){
		ClearChallengeTheThoughtForm();
		MovePageRight('#pageWhatDidIThinkFeelings', _currentPage);
	});

	$('#saveReflectionBtn').on('click', function(){
		SaveThoughtReflection();
	});

	$('#saveEventBtn').on('click', function(){
		SaveEvent();
	});

	$('#cancelEventBtn').on('click', function(){
		// if($('#theEventTextGoesHere').html() === ''){
		// 	MovePageRight('#pageFeelingsEventsHome', _currentPage);
		// 	return;
		// }

		// $('#viewEvent').removeClass('displayNone');
		// $('#addEventForm').addClass('displayNone');
		// $('#editEventBtn').removeClass('displayNone');

		ResetFeelingsTool();

		if (_isSearching)
			MovePageRight('#pageFeelingsSearch', _currentPage);
		else
			MovePageRight('#pageFeelingsEventsHome', _currentPage);
	});

	$('#editEventBtn').on('click', function(){
		var event = GetEventFromStorage(_eventID);

		$('#feelingsEventText').val(event.Text);
		$('#eventTagSelect').val(event.Tag);

		$('#addEventForm').removeClass('displayNone');
		$('#editEventBtn').addClass('displayNone');
		$('#viewEvent').addClass('displayNone');
	});

	$('.feelingsSaveActionBtn').on('click', function(){
		SaveAction();
	});

	$('#feelingsCancelActionBtn').on('click', function(){
		$('#whatDidIDoForm').addClass('displayNone');
		$('#feelingsAddNewActionBtn').removeClass('displayNone');
		$('#feelingsActionsText').val('');
		$('#feelingActionPositive').prop('checked', false);
		$('#feelingActionNegative').prop('checked', false);
	});

	$('#newPositiveActionDoneBtn').on('click', function(){
		MovePageRight('#pageWhatDidIDoFeelings', _currentPage);
	});

	$('#btnCancelPositiveAction').on('click', function(){
		$('#newPositiveActionForm').addClass('displayNone');
		$('#feelingsAddNewPositiveActionBtn').removeClass('displayNone');
	});

	$('#saveNewPositiveActionBtn').on('click', function(){
		SavePositiveAction();
	});

	$('#saveHowIRespondFeelingsBtn').on('click', function(){
		SaveFeelings();
	});

	$('#feelingsAddNewPositiveActionBtn').on('click', function(){
		$('#feelingsWhatDidIDoText').val('');
		$('#feelingsDoable').prop('checked', false);
		$('#feelingsHelpful').prop('checked', false);
		$('#feelingsAppropriate').prop('checked', false);

		_isEditingPositiveAction = false;

		$('#newPositiveActionForm').removeClass('displayNone');
		$('#feelingsAddNewPositiveActionBtn').addClass('displayNone');
	});

	$('#saveActionsReflectionBtn').on('click', function(){
		SaveActionsReflection();
	});

	$('#submitEventSearchBtn').on('click', function(){
		SearchEvents();
	});

	$('#editSummaryFeelingsBtn').on('click', function(){
		_isEditingFeelings = true;
		SetupEditFeelings();
		MovePageLeft("#pageLearningFeelings", _currentPage);
	});

	$('#editSummaryActionsBtn').on('click', function(){
		_isEditingFeelings = true;
		SetupEditActions();
		MovePageLeft("#pageWhatDidIDoFeelings", _currentPage);
	});

	$('#editSummaryThoughtsBtn').on('click', function(){
		_isEditingFeelings = true;
		SetupEditThoughts();
		MovePageLeft("#pageWhatDidIThinkFeelings", _currentPage);
	});

} // end Initialize

function ActionsPositiveOrNegativeCheckboxes(){ // KEEPING THIS FUNCTION

	$('#feelingActionPositive').on('change', function(){
		$('#feelingActionNegative').prop('checked', false);
	});
	$('#feelingActionNegative').on('change', function(){
		$('#feelingActionPositive').prop('checked', false);
	});
}

function AssumptionCheckboxes(){  // KEEPING THIS FUNCTION
	$('#assumptionYes').on('change', function(){
		$('#assumptionNo').prop('checked', false);
	});
	$('#assumptionNo').on('change', function(){
		$('#assumptionYes').prop('checked', false);
	});
}

function BuildBadFeelingsHtml(badArray){
	//put them on the page
	_howThoughtsFeelPopup = badArray;
	var length = badArray.length;
	var i = 0;
	var feelings = "";
	for(var i=0; i < length; i++){
		feelings += ' * ' + badArray[i];
	}
	var html = '<div>' + feelings + '</div>';

	$('#feelingsAboutThoughts').html(html);
}

function BuildEventListHtml(data) {
	_allEventsStorage = data;

	var max = 30;
	var html = '';
	var exists;
	var month = '';
	var anevent;
	var date = '';
	var months = [];
	var eventText = "";

	for(var i = 0; i < data.length; i++){
		anevent = data[i];
		date = moment(anevent.CreateTime).format("MMM DD, YYYY");
		month = moment(anevent.CreateTime).format("MMMM");
		eventText = anevent.Text;

		if(anevent.Text === "" || anevent.Text === null){
			eventText = "None";
		}

		if (eventText.length > max){
			eventText = jQuery.trim(eventText).substring(0, max).split(" ").slice(0, -1).join(" ") + "...";
		}

		if(months.indexOf(month) == -1){
			months.push(month);
			html += '<h4 class="journalMonth">' + month + '</h4>';
		}

		// ADD CODE TO CONCATENATE EVENT TITLE/NAME!!! *********************

		html += '<div class="eventRow" id="' + anevent.ID + '">';
		html += '<div class="eventName font700">' + eventText + '</div>';
		html += '<div class="row"><div class="eventDate col-xs-3">' + date + '</div>';
		html += '<div class="eventTag col-xs-3">' + anevent.Tag + '</div>';
		html += '<div class="eventView col-xs-3">View</div>';
		html += '<div class="deleteView col-xs-3">Delete</div>';
		html += '</div></div>';

	} //end for loop

	return html;
}

function BuildGoodFeelingsHtml(goodArray) {
	_howWantFeelPopup = goodArray;
	var length = goodArray.length;
	var feelings = "";
	for(var i=0; i < length; i++){
		feelings += ' * ' + goodArray[i];
	}
	var html = '<div>' + feelings + '</div>';

	$('#howIWantToFeel').html(html);
}

function BuildNewActionHtml(actionID, negOrPos, actionText) {
	var max = 45;
	var short = actionText;

	if (actionText.length > max){
		short = jQuery.trim(actionText).substring(0, max).split(" ").slice(0, -1).join(" ") + "...";
	}

	var html = '<div class="newAction" id="' + actionID + '">';
	html += '<div class="text clearBoth ' + negOrPos + '">' + short + '</div>';
	html += '<input type="hidden" class="hdnActionOverflow" value="' + actionText + '" />';
	html += '<div class="newActionEdit left blue">Edit</div>';

	if(negOrPos == 'negative'){
		html += '<div class="newActionExamine right blue">Examine this action</div>';
	}

	html += '</div>';

	return html;
}

function BuildNewThoughtHtml(thoughtID, thoughtNegOrPos, thoughtText){
	var shortenedThought = thoughtText;
	var max = 45;

	if (thoughtText.length > max){
		shortenedThought = jQuery.trim(thoughtText).substring(0, max).split(" ").slice(0, -1).join(" ") + "...";
	}

	var html = '<div class="newThought" id="' + thoughtID + '">';
	html += '<div class="text clearBoth ' + thoughtNegOrPos + '">' + shortenedThought + '</div>';
	html += '<div class="newThoughtEdit left blue">Edit</div>';

	html += '<input type="hidden" class="newThoughtOverflow" value="' + thoughtText + '" />';

	if(thoughtNegOrPos == 'negative'){
		html += '<div class="newThoughtExamine right blue">Examine this thought</div>';
	}

	html += '</div>';

	return html;
}

function BuildPositiveActionListHtml(paID, paText) {
	var html = '<div class="newPositiveAction" id="' + paID + '">';
	html += '<div class="text clearBoth">' + paText + '</div>';
	html += '<div class="newPositiveActionEdit left blue">Edit</div></div>';

	return html;
}

function ClearActionsForm(){
	// Actions
	$('#whatDidIDoForm').removeClass('displayNone');
	$('#feelingsAddNewActionBtn').addClass('displayNone');
	$('#newActionsGoHere').html('');
	$('#feelingActionPositive').prop('checked', false);
	$('#feelingActionNegative').prop('checked', false);
	$('#actionsReflectionText').val('');
	// End Actions

	// Positive Actions
	$('#oldActionGoesHere').html('');
	$('#newPositiveActionsGoHere').html('');
	$('#feelingsWhatDidIDoText').val('');
	$('#feelingsDoable').prop('checked', false);
	$('#feelingsHelpful').prop('checked', false);
	$('#feelingsAppropriate').prop('checked', false);
	$('#newPositiveActionForm').removeClass('displayNone');
	$('#feelingsAddNewPositiveActionBtn').addClass('displayNone');
	// End Positive Actions

	_isEditingAction = false;

	_positiveActionID = null;
	_isEditingPositiveAction = "";
	_positiveActionStorage = [];
}

function ClearChallengeTheThoughtForm(){
	// Clear Challenge the Thought Form
	$('#whatIThoughtFeelings').html('');
	$('#howMuchIBelieveSelect').val(0);
	$('#feelingsAboutThoughts').html('');
	$('#howIWantToFeel').html('');

	$('#howThoughtsFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			$(this).attr('checked', false);
		}
	});
	$('#thoughtsOtherText').val('');

	$('#howWantFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			$(this).attr('checked', false);
		}
	});
	$('#wantFeelOtherText').val('');

	$('#otherViewsText').val('');
	$('#assumptionYes').attr('checked', false);
	$('#assumptionNo').attr('checked', false);
	$('#thoughtFactsText').val('');
	$('#thoughtBalancedText').val('');

	_howThoughtsFeelPopup = [];
	_howWantFeelPopup = [];
	_thoughtID = null;
	_isEditingThought = false;
	// End clearing Form
}

function ClearFeelingsForm(){
	$('#feelingsEventText').val('');
	$('#selectedFeelingsGoHere').html('');

	$('#howDidIFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			$(this).prop('checked', false);
		}
	});

	$('#howOtherText').val('');

	$('#intensitySelect').val(0);
	$('#feelingsSymptomsText').val('');
	$('#eventDegreeSelect').val(0);

	_howDidIFeelPopup = [];
}

function ClearSummaryPage(){

	$('#summaryEventHere').html('');
	$('#summaryTagHere').html('');
	$('#myFeelingsHere').html('');
	$('#intensityHere').html('');
	$('#symptomsHere').html('');
	$('#degreeBotheredHere').html('');
	// $('#oldActionsHere').html('');
	// $('#newPositiveActionsHere').html('');
	$('#putNewPositiveActionsHereAccordion').html('');
	$('#putOldActionsHereAccordion').html('');
	$('#putNewPositiveThoughtsHereAccordion').html('');
	$('#putOldThoughtsHereAccordion').html('');
	$('#putFeelingsHereAccordion').html('');
	$('#feelingsThoughtsAccordion').html('');
	$('#feelingsFeelingsAccordion').html('');
	$('#feelingsActionsAccordion').html('');
	$('#actionReflectionGoesHere').html('');
	$('#oldThoughtsHere').html('');
	$('#newPositiveThoughtsHere').html('');
	$('#thoughtReflectionGoesHere').html('');

}

function ClearThoughtsForm(){
	// Thoughts
	$('#newThoughtsGoHere').html('');
	$('#newThoughtsForm').removeClass('displayNone');
	$('#newThoughtText').val('');
	$('#addNewThoughtBtn').addClass('displayNone');
	$('#thoughtReflectionText').val('');
	// End Thoughts

	// Examine the Thought
	$('#whatIThoughtFeelings').html('');
	$('#howMuchIBelieveSelect').val(0);
	$('#feelingsAboutThoughts').html('');
	$('#howIWantToFeel').html('');

	$('#howThoughtsFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			$(this).prop('checked', false);
		}
	});
	$('#thoughtsOtherText').val('');

	$('#howWantFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			$(this).prop('checked', false);
		}
	});
	$('#wantFeelOtherText').val('');

	$('#otherViewsText').val('');
	$('#assumptionYes').prop('checked', false);
	$('#assumptionNo').prop('checked', false);
	$('#thoughtFactsText').val('');
	$('#thoughtBalancedText').val('');
	// End Examine the Thought
}

function EditCompletedEvent(data){ // SHOWS THE SUMMARY PAGE *****************
		//first, find the event by the ID with this loop
	ClearSummaryPage();

	var event = GetEventFromStorage(_eventID);

	//Add Event to page
	$('#summaryEventHere').html(event.Text);
	$('#summaryTagHere').html("Tag: " + event.Tag);

	//Add Feelings to page
	var idFeelings = "feelingsFeelingsGoHere";
	var accordionFeelings = $('#feelingsFeelingsTemplate').html();

    $('#feelingsFeelingsAccordion').append(accordionFeelings);

    var panelFeelings = $('#feelingsFeelingsAccordion .panel:last-child');
    panelFeelings.find('.panel-collapse').attr('id', idFeelings);

    var titleFeelings = '<span class="activityTitle">Emotional Response</span>';
    var iconFeelings = '<i class="iconAccordion fa fa-caret-left"></i>';
    $('.feelingsTitleWrapper ').html(titleFeelings + iconFeelings);

	$('.collapse').on('show.bs.collapse', function(){
		var i = $(this).parent().find('i');
		i.toggleClass('fa-caret-left fa-caret-down');
	}).on('hide.bs.collapse', function(){
		var i = $(this).parent().find('i');
		i.toggleClass('fa-caret-down fa-caret-left');
	});

	if (event.Feelings !== null && event.Feelings.length > 0) {
		var feeling = event.Feelings[0];

		$('#putFeelingsHereAccordion').html(feeling.Feelings);
		panelFeelings.find('#putFeelingsHereAccordion').append(feeling.Feelings);

		$('#intensityHere').html("Intensity: " + feeling.Intensity);
		$('#symptomsHere').html(feeling.Symptoms);
		$('#degreeBotheredHere').html("Degree this bothered me: " + feeling.DegreeBothered);
	}

	// Add Actions to page
	var idActions = "feelingsActionsGoHere";
	var accordionActions = $('#feelingsActionsTemplate').html();

    $('#feelingsActionsAccordion').append(accordionActions);

    var panelActions = $('#feelingsActionsAccordion .panel:last-child');
    panelActions.find('.panel-collapse').attr('id', idActions);

    var titleActions = '<span class="activityTitle">Actions</span>';
    var iconActions = '<i class="iconAccordion fa fa-caret-left"></i>';
    $('.actionTitleWrapper ').html(titleActions + iconActions);

	$('.collapse').on('show.bs.collapse', function(){
		var i = $(this).parent().find('i');
		i.toggleClass('fa-caret-left fa-caret-down');
	}).on('hide.bs.collapse', function(){
		var i = $(this).parent().find('i');
		i.toggleClass('fa-caret-down fa-caret-left');
	});

	$('#actionReflectionGoesHere').html(event.ActionReflection);

	if (event.Actions !== null && event.Actions.length > 0) {
		var allActions = "";
		var actionIDs = [];
		var x = 0
		for(x=0; x < event["Actions"].length; x++){
			var action = event["Actions"][x];
			if(action.Rating == "negative"){
				allActions += "<p>" + action.Text + "</p>";
				actionIDs.push(action.ID);
			}
		}

		panelActions.find('#putOldActionsHereAccordion').html(allActions);

		// Add Positive Actions to page
		var positiveActions = "";
		var y = 0;
		for(y=0; y < actionIDs.length; y++){
			var data = { userID: _user.ID, ActionID: actionIDs[y] }
			$.ajax({
				type: "GET",
				url: config.Path + '/ftd/getpositiveaction',
				data: data
			}).done(function(data){
				var q = 0;
				for(q=0; q<data.length; q++){
					positiveActions += "<p>" + data[q]["Text"] + "</p>";
				}
				panelActions.find('#putNewPositiveActionsHereAccordion').append(positiveActions);

			});

		}
	}

	// Add Thoughts to page
	var idThought = "feelingsThoughtsGoHere";
	var accordionThought = $('#feelingsThoughtsTemplate').html();

    $('#feelingsThoughtsAccordion').append(accordionThought);

    var panelThought = $('#feelingsThoughtsAccordion .panel:last-child');
    panelThought.find('.panel-collapse').attr('id', idThought);

    var titleThought = '<span class="activityTitle">Thoughts</span>';
    var iconThought = '<i class="iconAccordion fa fa-caret-left"></i>';
    $('.thoughtTitleWrapper ').html(titleThought + iconThought);

	$('.collapse').on('show.bs.collapse', function(){
		var i = $(this).parent().find('i');
		i.toggleClass('fa-caret-left fa-caret-down');
	}).on('hide.bs.collapse', function(){
		var i = $(this).parent().find('i');
		i.toggleClass('fa-caret-down fa-caret-left');
	});

	$('#thoughtReflectionGoesHere').html(event.ThoughtReflection);

	if (event.Thoughts !== null && event.Thoughts.length > 0) {
		var allThoughts = "";
		var positiveThoughts = "";
		var w = 0;

		for(w=0; w < event["Thoughts"].length; w++){
			var thought = event["Thoughts"][w];
			if (thought.Rating == "negative"){
				allThoughts += "<p>" + thought.Text + "</p>";
				if(thought.Balanced !== null){
					positiveThoughts += "<p>" + thought.Balanced + "</p>";
				}
			}
		}

		panelThought.find('#putOldThoughtsHereAccordion').html(allThoughts);

		panelThought.find('#putNewPositiveThoughtsHereAccordion').html(positiveThoughts);

	}
}

function GatherHowDidIFeelPopupData(){

	_howDidIFeelPopup = [];  //You have to clear it first; otherwise, every time they click 'save' it will duplicate data

	var inputData = "";
	$('#howDidIFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			inputData = $(this).data('how-type');

			_howDidIFeelPopup.push(inputData);
		}
	});

	var other = $('#howOtherText').val();

	if(other !== ""){
		_howDidIFeelPopup.push(other);
	}

	if(_howDidIFeelPopup.length == 0){
		ShowError("Please choose or enter at least one feeling");
		return;
	}

	$('#selectedFeelingsGoHere').html('');

	var length = _howDidIFeelPopup.length;
	var i = 0;
	for(i=0; i<length; i++){
		$('#selectedFeelingsGoHere').append(' * ' + _howDidIFeelPopup[i]);
	}
}

function GatherHowThoughtsFeelPopUpData(){ //FROM CHALLENGE THE THOUGHT PAGE

	_howThoughtsFeelPopup = [];  //You have to clear it first; otherwise, every time they click 'save' it will duplicate data

	var inputData = "";
	$('#howThoughtsFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			inputID = $(this).data('thoughts-type');

			_howThoughtsFeelPopup.push(inputID);
		}
	});

	var other = $('#thoughtsOtherText').val();

	if(other !== ""){
		_howThoughtsFeelPopup.push(other);
	}

	if(_howThoughtsFeelPopup.length == 0){
		ShowError("Please choose or enter at least one feeling");
		return;
	}

	MovePageDown('#pageChallengeTheThoughtFeelings', '#pageHowThoughtsFeelPopUp');

	BuildBadFeelingsHtml(_howThoughtsFeelPopup);
}

function GatherWantFeelPopUpData(){ // FROM CHALLENGE THE THOUGHT PAGE

	_howWantFeelPopup = [];  //You have to clear it first; otherwise, every time they click 'save' it will duplicate data

	var inputData = "";
	$('#howWantFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			inputID = $(this).data('want-type');

			_howWantFeelPopup.push(inputID);
		}
	});

	var other = $('#wantFeelOtherText').val();

	if(other !== ""){
		_howWantFeelPopup.push(other);
	}

	if(_howWantFeelPopup.length == 0){
		ShowError("Please choose or enter at least one feeling");
		return;
	}

	MovePageDown('#pageChallengeTheThoughtFeelings', '#pageHowIWantToFeelPopUp');

	BuildGoodFeelingsHtml(_howWantFeelPopup);
}

function GetActionFromStorage(eventID, actionID){
	var event = GetEventFromStorage(eventID)

	for(var i=0; i < event.Actions.length; i++){
		var a = event.Actions[i];

		if(a.ID == actionID){
			return a;
		}
	}

	return null;
}

function GetEvents(callback){

	$.ajax({
		type: "GET",
		url: config.Path + '/ftd/getevents',
		data: { userID: _user.ID }
	}).done(function(data){

		if(data === null){
			HandleError("ftd/getevents returned null");
			return;
		}

		_allEventsStorage = data;

		var html = '';

		if (data.length == 0){
			html = "<p>You currently have no events...</p>";
		}
		else {
			html = BuildEventListHtml(data);
		}

		$('#putEventsHere').html(html);

		SetupEventListEvents();

		if (typeof callback != "undefined" && callback !== null)
			callback();

	}); // end .done

}

function GetEventFromStorage(eventID){
	var id = eventID;
	var i = 0;
	var length = _allEventsStorage.length;

	for(i=0; i < length; i++){
		if(_allEventsStorage[i]["ID"] == id){
			var activeEventObject = _allEventsStorage[i];
			return activeEventObject;
		}
	}

	return null;
}

function GetThoughtFromStorage(eventID, thoughtID){
	var event = GetEventFromStorage(eventID)

	for(var i=0; i < event.Thoughts.length; i++){
		var t = event.Thoughts[i];

		if(t.ID == thoughtID){
			return t;
		}
	}

	return null;
}

function GetPositiveActions(){
	var data = { UserID: _user.id, ActionID: _actionID };

	$.ajax({
		type: "GET",
		url: config.Path + '/ftd/getpositiveaction',
		data: data
	}).done(function(data) {
		if (data === null) {
			return;
		}

		_positiveActionStorage = data;

		if (data.length == 0){
			$('#newPositiveActionForm').removeClass('displayNone');
			$('#feelingsAddNewPositiveActionBtn').addClass('displayNone');
		}
		else {
			$('#newPositiveActionForm').addClass('displayNone');
			$('#feelingsAddNewPositiveActionBtn').removeClass('displayNone');
		}

		var html = '';
		for(var i=0; i < data.length; i++){
			var pa = data[i];

			html += BuildPositiveActionListHtml(pa.ID, pa.Text);
		}

		$('#newPositiveActionsGoHere').html(html);

		SetupPositiveActionEvents();
	}); // end .done
}

function GetPositiveActionFromStorage(positiveActionID) {
	for(var a=0; a < _positiveActionStorage.length; a++){
		var pa = _positiveActionStorage[a];

		if(positiveActionID == pa.ID){
			return pa;
		}
	}

	return null;
}

function LoadFTDImage(event){

	// var event = GetEventFromStorage(_eventID);

	if (event.Feelings !== null && event.Feelings.length > 0)
		$('#goToFeelingsBtn').attr('src', 'img/assets/ftd_feelings.png');
	else
		$('#goToFeelingsBtn').attr('src', 'img/assets/ftd_feelings_off.png');

	if (event.Actions !== null && event.Actions.length > 0)
		$('#goToActionsBtn').attr('src', 'img/assets/ftd_do.png');
	else
		$('#goToActionsBtn').attr('src', 'img/assets/ftd_do_off.png');

	if (event.Thoughts !== null && event.Thoughts.length > 0)
		$('#goToThoughtsBtn').attr('src', 'img/assets/ftd_thoughts.png');
	else
		$('#goToThoughtsBtn').attr('src', 'img/assets/ftd_thoughts_off.png');

	$('.ftdImage').fadeIn();
}

function PositiveOrNegativeCheckboxes(){  // KEEPING THIS FUNCTION
	$('#newThoughtPositive').on('change', function(){
		$('#newThoughtNegative').prop('checked', false);
	});
	$('#newThoughtNegative').on('change', function(){
		$('#newThoughtPositive').prop('checked', false);
	});
}

function ResetFeelingsTool(){

	_eventID = null;

	// Event
	$('#theEventTextGoesHere').html('');
	$('#theEventTagGoesHere').html('');
	$('#eventTagSelect').val(0);
	$('#addEventForm').removeClass('displayNone');
	$('#saveEventBtn').removeClass('displayNone');
	$('#cancelEventBtn').removeClass('displayNone');
	$('#editEventBtn').addClass('displayNone');
	// End Event

	// Feelings
	$('#feelingsEventText').val('');
	$('#selectedFeelingsGoHere').html('');

	$('#howDidIFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			$(this).prop('checked', false);
		}
	});
	$('#howOtherText').val('');

	$('#intensitySelect').val(0);
	$('#feelingsSymptomsText').val('');
	$('#eventDegreeSelect').val(0);
	// End Feelings

	// Thoughts
	$('#newThoughtsGoHere').html('');
	$('#newThoughtsForm').removeClass('displayNone');
	$('#newThoughtText').val('');
	$('#addNewThoughtBtn').addClass('displayNone');
	$('#thoughtReflectionText').val('');
	// End Thoughts

	// Examine the Thought
	$('#whatIThoughtFeelings').html('');
	$('#howMuchIBelieveSelect').val(0);
	$('#feelingsAboutThoughts').html('');
	$('#howIWantToFeel').html('');

	$('#howThoughtsFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			$(this).prop('checked', false);
		}
	});
	$('#thoughtsOtherText').val('');

	$('#howWantFeelCheckboxes').find('input').each(function(){
		if($(this).is(':checked')){
			$(this).prop('checked', false);
		}
	});
	$('#wantFeelOtherText').val('');

	$('#otherViewsText').val('');
	$('#assumptionYes').prop('checked', false);
	$('#assumptionNo').prop('checked', false);
	$('#thoughtFactsText').val('');
	$('#thoughtBalancedText').val('');
	// End Examine the Thought

	// Actions
	$('#whatDidIDoForm').removeClass('displayNone');
	$('#feelingsAddNewActionBtn').addClass('displayNone');
	$('#newActionsGoHere').html('');
	$('#feelingActionPositive').prop('checked', false);
	$('#feelingActionNegative').prop('checked', false);
	$('#actionsReflectionText').val('');
	// End Actions

	// Positive Actions
	$('#feelingsActionsAccordion').html('');
	$('#feelingsWhatDidIDoText').val('');
	$('#feelingsDoable').prop('checked', false);
	$('#feelingsHelpful').prop('checked', false);
	$('#feelingsAppropriate').prop('checked', false);
	$('#newPositiveActionForm').removeClass('displayNone');
	$('#feelingsAddNewPositiveActionBtn').addClass('displayNone');
	// End Positive Actions

	PositiveOrNegativeCheckboxes();
	AssumptionCheckboxes();
	ActionsPositiveOrNegativeCheckboxes();

}

function SaveAction(){  // KEEPING THIS FUNCTION

	var tempActionID = _actionID;
	var max = 30;

	if(!_isEditingAction==true){
		tempActionID = CreateGuid();
	}

	var actionText = $('#feelingsActionsText').val();
	if(actionText === ""){
		ShowError("Please enter an action");
		return;
	}
	var actionNegOrPos = 'negative';
	if(!$("#feelingActionPositive").is(':checked') && !$('#feelingActionNegative').is(':checked')){
		ShowError("Please select Positive or Negative");
		return;
	} else if($("#feelingActionPositive").is(':checked')){
		actionNegOrPos = 'positive';
	}

	ShowLoader();

	var savedAction = null;

	if (_isEditingAction === true){
		savedAction = GetActionFromStorage(_eventID, _actionID);
		savedAction.Text = actionText;
		savedAction.Rating = actionNegOrPos;
	}
	else {
		savedAction = { userID: _user.ID, FTDEventID: _eventID, ID: "", Text: actionText, Rating: actionNegOrPos };
	}

	$.ajax({
		type: "POST",
		url: config.Path + '/ftd/saveaction',
		data: savedAction
	}).done(function(data){

		if(data==null){
			HandleError("Save Action returned null.");
			return;
		}

		GetEvents(function(){
			var html = BuildNewActionHtml(tempActionID, actionNegOrPos, actionText);

			if(_isEditingAction==true){
				var parent = $('#' + _actionID);
				$(parent).html('');
				$(parent).replaceWith(html);
			} else {
				$('#newActionsGoHere').append(html);
			}

			SetupActionEvents();

			ShowSuccess("Action was saved");

			$('#goToSummaryBtn').removeClass('displayNone');

			$('#' + tempActionID).attr('id', data.ID); // set the div ID to the thought's API/DB ID


			$('#feelingsAddNewActionBtn').on('click', function(){

				$('#whatDidIDoForm').removeClass('displayNone');
				$('#feelingsAddNewActionBtn').addClass('displayNone');
			});

			$('#whatDidIDoForm').addClass('displayNone');

			$('#feelingsActionsText').val("");
			$('#feelingActionPositive').prop('checked', false);
			$('#feelingActionNegative').prop('checked', false);

			$('#feelingsAddNewActionBtn').removeClass('displayNone');

			_isEditingAction = false;

			var event = GetEventFromStorage(_eventID);
			LoadFTDImage(event);

			HideLoader();
		});
	}); // end .done

}

function SaveActionsReflection(){  // KEEPING THIS FUNCTION

	var actionReflection = $('#actionsReflectionText').val();
	if(actionReflection === ""){
		ShowError("Please reflect upon these actions");
		$('#actionsReflectionText').focus();
		return;
	}

	var eventObject = GetEventFromStorage(_eventID);
	eventObject["ActionReflection"] = actionReflection;

	// need EVENT ID not ACTION ID to save this (b/c the reflection is for multiple actions)
	var data = eventObject;

	$.ajax({
		type: "POST",
		url: config.Path + '/ftd/saveevent',
		data: data
	}).done(function(data){

		if(data==null){
			HandleError("Save Action Reflection returned null.");
			return;
		}

		ShowSuccess("Reflection was saved");
		GetEvents();
	});

}

function SaveChallengeThought(){  // KEEPING THIS FUNCTION

	var believe = $('#howMuchIBelieveSelect').val();
	if(believe == 0){
		ShowError("Please select how much you believe this to be true");
		return;
	}

	if(_howThoughtsFeelPopup.length == 0){
		ShowError("Please enter how these thoughts make you feel");
		return;
	}
	if(_howWantFeelPopup.length == 0){
		ShowError("Please enter how you want to feel");
		return;
	}

	var otherPoints = $('#otherViewsText').val();
	if(otherPoints === ""){
		ShowError("Please enter at least one other possible point of view");
		$('#otherViewsText').focus();
		return;
	}

	var assumptionYesNo = 'No';
	if(!$("#assumptionYes").is(':checked') && !$('#assumptionNo').is(':checked')){
		ShowError("Please select if this is an assumption or not");
		return;
	} else if($("#assumptionYes").is(':checked')){
		assumptionYesNo = 'Yes';
	}

	var thoughtFacts = $('#thoughtFactsText').val();
	if(thoughtFacts === ""){
		ShowError("Please enter facts that are for or against your thought");
		$('#thoughtFactsText').focus();
		return;
	}

	var balancedThought = $('#thoughtBalancedText').val();
	if(balancedThought === ""){
		ShowError("Please enter a more balanced, positive thought");
		$('#thoughtBalancedText').focus();
		return;
	}

	//convert arrays to strings ******************************
	_howThoughtsFeelPopup = _howThoughtsFeelPopup.join(', ');
	_howWantFeelPopup = _howWantFeelPopup.join(', ');

	var savedThought = GetThoughtFromStorage(_eventID, _thoughtID);
	savedThought.Believe = believe;
	savedThought.HowThoughtsFeel = _howThoughtsFeelPopup;
	savedThought.HowWantFeel = _howWantFeelPopup;
	savedThought.OtherPoints = otherPoints;
	savedThought.Assumption = assumptionYesNo;
	savedThought.Facts = thoughtFacts;
	savedThought.Balanced = balancedThought;

	$.ajax({
		type: "POST",
		url: config.Path + '/ftd/savethought',
		data: savedThought
	}).done(function(data){

		if(data==null){
			HandleError("Save Challenge Thought returned null.");
			return;
		}
		ShowSuccess("Responses Saved");

		GetEvents();

		MovePageRight('#pageWhatDidIThinkFeelings', _currentPage);

		ClearChallengeTheThoughtForm();
		// Clear Challenge the Thought Form
		$('#whatIThoughtFeelings').html('');
		$('#howMuchIBelieveSelect').val(0);
		$('#feelingsAboutThoughts').html('');
		$('#howIWantToFeel').html('');

		$('#howThoughtsFeelCheckboxes').find('input').each(function(){
			if($(this).is(':checked')){
				$(this).prop('checked', false);
			}
		});
		$('#thoughtsOtherText').val('');

		$('#howWantFeelCheckboxes').find('input').each(function(){
			if($(this).is(':checked')){
				$(this).prop('checked', false);
			}
		});
		$('#wantFeelOtherText').val('');

		$('#otherViewsText').val('');
		$('#assumptionYes').prop('checked', false);
		$('#assumptionNo').prop('checked', false);
		$('#thoughtFactsText').val('');
		$('#thoughtBalancedText').val('');

		_howThoughtsFeelPopup = [];
		_howWantFeelPopup = [];
		_thoughtID = null;
		_isEditingThought = false;
		// End clearing Form

		// {"ID":"2684a9e3-9291-4f3d-9f70-bce921d8cd22","FTDEventID":"fc2d00dd-1879-404f-b4b0-036fedcd27f9","Text":"thought","Rating":"negative","Believe":"Extremely","HowThoughtsFeel":"insulted","HowWantFeel":"proud","OtherPoints":"challenge s ajldsjflakjf","Assumption":"No","Facts":"facts jlakjdlkfjajf lsa","Balanced":"replaces lkajdlfjasldjflkasd","CreateTime":"2015-02-19T19:41:24.297","UpdateTime":"2015-02-19T19:42:09.2177743Z"}
	}); // .done
}

function SaveEvent(){    // KEEPING THIS FUNCTION
	var theEvent = $('#feelingsEventText').val();
	if (theEvent === ""){
		ShowError("Please enter an event");
		$('#feelingsEventText').focus();
		return;
	}

	var eventTag = $('#eventTagSelect').val();
	if (eventTag ==0){
		ShowError("Please tag the event");
		return;
	}

	var data = { userID: _user.ID, ID: _eventID, Text: theEvent, Tag: eventTag };
	ShowLoader();

	$.ajax({
		type: "POST",
		url: config.Path + '/ftd/saveevent',
		data: data
	}).done(function(data){

		if(data==null){
			HandleError("Save Event returned null.");
			return;
		}

		_eventID = data.ID;

		// ShowSuccess("Event was saved");
		GetEvents(function(){
			ShowEventText(data);

			var event = GetEventFromStorage(_eventID);
			LoadFTDImage(event);
			// LoadFTDImage(data);
			HideLoader();
			$('#viewEvent').removeClass('displayNone');
		});
	}); // end .done

	//.done
	// ShowSuccess("Event was successfully saved");
	// _eventID = data...



} // end SaveEvent function

function SaveFeelings(){ // SAVING FEELINGS *****************
	var event = GetEventFromStorage(_eventID);

	if($('#selectedFeelingsGoHere').html() === ""){
		ShowError("Please choose at least one feeling");
		return;
	}
	// _howDidIFeelPopup is an array
	// if(_howDidIFeelPopup.length==0){
	// 	ShowError("Please choose at least one feeling");
	// 	return;
	// }

	var intensity = $('#intensitySelect').val();
	if(intensity==0){
		ShowError("Please choose an intensity");
		return;
	}

	var symptoms = $('#feelingsSymptomsText').val();
	if(symptoms === ""){
		ShowError("Please enter your symptoms or type 'None'");
		return;
	}

	var degreeBothered = $('#eventDegreeSelect').val();
	if(degreeBothered==0){
		ShowError("Please select the degree this bothered you");
		return;
	}

	var howDidIFeelString = _howDidIFeelPopup.join(', ');

	var feelingID = "";

	if(event.Feelings !== null && event.Feelings.length > 0){
		feelingID = event.Feelings[0].ID;
	}

	var data = { ID: feelingID, userID: _user.ID, FTDEventID: _eventID, Feelings: howDidIFeelString, Symptoms: symptoms, DegreeBothered: degreeBothered,
	Intensity: intensity };

	ShowLoader();

	$.ajax({
		type: "POST",
		url: config.Path + '/ftd/savefeeling',
		data: data
	}).done(function(data){

		if(data==null){
			HandleError("Save Feeling returned null.");
			return;
		}

		$('#goToSummaryBtn').removeClass('displayNone');

		GetEvents(function(){
			ShowSuccess("Feelings were saved");

			var event = GetEventFromStorage(_eventID);
			LoadFTDImage(event);

			MovePageLeft("#pageFeelingsNewEventPage", _currentPage);
			HideLoader();
		});

	}); // end .done

}

function SavePositiveAction(){ // KEEPING THIS FUNCTION

	var tempPositiveActionID = _positiveActionID;

	if(!_isEditingPositiveAction){
		tempPositiveActionID = CreateGuid();
	}

	var doable = false;
	var helpful = false;
	var appropriate = false;

	var positiveActionText = $("#feelingsWhatDidIDoText").val();

	if (positiveActionText === ""){
		ShowError("Please enter a positive action");
		$('#feelingsWhatDidIDoText').focus();
		return;
	}

	if (!$("#feelingsDoable").is(':checked') && !$("#feelingsHelpful").is(':checked') && !$("#feelingsAppropriate").is(':checked')){
		ShowError("Please check at least one option");
		return;
	}

	ShowLoader();

	if ($("#feelingsDoable").is(':checked'))
		doable = true;

	if ($("#feelingsHelpful").is(':checked'))
		helpful = true;

	if ($("#feelingsAppropriate").is(':checked'))
		appropriate = true;

	var html = BuildPositiveActionListHtml(tempPositiveActionID, positiveActionText);

	var savedPA = null;
	if (_isEditingPositiveAction) {
		savedPA = GetPositiveActionFromStorage(_positiveActionID);
		savedPA.Text = positiveActionText;
		savedPA.Doable = doable;
		savedPA.Helpful = helpful;
		savedPA.Appropriate = appropriate;
	}
	else {
	 	savedPA = { userID: _user.ID, ActionID: _actionID, ID: "", Text: positiveActionText, Doable: doable, Helpful: helpful, Appropriate: appropriate };
	}

	$.ajax({
		type: "POST",
		url: config.Path + '/ftd/savepositiveaction',
		data: savedPA
	}).done(function(data) {
		if(data === null){
			HandleError("Save Positive Action returned null.");
			return;
		}

		ShowSuccess("Positive Action saved");
		GetEvents();
		GetPositiveActions();

		$('#newPositiveActionForm').addClass('displayNone');

		$('#feelingsWhatDidIDoText').val("");

		$("#feelingsDoable").prop('checked', false);
		$("#feelingsHelpful").prop('checked', false);
		$("#feelingsAppropriate").prop('checked', false);

		$('#feelingsAddNewPositiveActionBtn').removeClass('displayNone');

		_isEditingPositiveAction = false;
		HideLoader();

	});
}

function SaveThought(){  // KEEPING THIS FUNCTION

	var tempThoughtID = _thoughtID;
	var max = 45;

	if(!_isEditingThought === true){
		tempThoughtID = CreateGuid();
	}

	var thoughtText = $('#newThoughtText').val();

	if(thoughtText === ""){
		ShowError("Please enter a thought");
		return;
	}

	var thoughtNegOrPos = 'negative';

	if(!$("#newThoughtPositive").is(':checked') && !$('#newThoughtNegative').is(':checked')){
		ShowError("Please select Positive or Negative");
		return;
	} else if($("#newThoughtPositive").is(':checked')){
		thoughtNegOrPos = 'positive';
	}

	var html = BuildNewThoughtHtml(tempThoughtID, thoughtNegOrPos, thoughtText);

	if(_isEditingThought==true){
		var parent = $('#' + _thoughtID);
		$(parent).html('');
		$(parent).replaceWith(html);
	} else {
		$('#newThoughtsGoHere').append(html);
	}

	SetupThoughtEvents();

	var savedThought = null;

	if (_isEditingThought === true){
		savedThought = GetThoughtFromStorage(_eventID, _thoughtID);
		savedThought.Text = thoughtText;
		savedThought.Rating = thoughtNegOrPos;
	}
	else {
		savedThought = { userID: _user.ID, FTDEventID: _eventID, ID: "", Text: thoughtText, Rating: thoughtNegOrPos };
	}

	$.ajax({
		type: "POST",
		url: config.Path + '/ftd/savethought',
		data: savedThought
	}).done(function(data){

		if(data==null){
			HandleError("Save Thought returned null.");
			return;
		}

		$('#goToSummaryBtn').removeClass('displayNone');

		$('div#' + tempThoughtID).attr('id', data.ID); // set the div ID to the thought's API/DB ID

		GetEvents(function(){
			var event = GetEventFromStorage(_eventID);
			LoadFTDImage(event);

			ShowSuccess("Thought was saved");

			$('#newThoughtsForm').addClass('displayNone');

			$('#newThoughtText').val("");
			$('#newThoughtNegative').prop('checked', false);
			$('#newThoughtPositive').prop('checked', false);

			$('#addNewThoughtBtn').removeClass('displayNone');

			_isEditingThought = false;
		});


	}); // end .done
}

function SaveThoughtReflection(){  // KEEPING THIS FUNCTION

	var thoughtReflection = $('#thoughtReflectionText').val();
	if(thoughtReflection === ""){
		ShowError("Please reflect upon these thoughts");
		$('#thoughtReflectionText').focus();
		return;
	}

	var eventObject = GetEventFromStorage(_eventID);
	eventObject["ThoughtReflection"] = thoughtReflection;

	// need EVENT ID not ACTION ID to save this (b/c the reflection is for multiple actions)
	var data = eventObject;

	$.ajax({
		type: "POST",
		url: config.Path + '/ftd/saveevent',
		data: data
	}).done(function(data){

		if(data==null){
			HandleError("Save Thought Reflection returned null.");
			return;
		}

		ShowSuccess("Reflection was saved");
		GetEvents();
	});

	// {"UserID":"21d4fa18-f86b-4aae-8c9d-975bc6e250bf","ID":"e7d6c5b0-280b-464a-bd28-f0ed6cda91f9","ThoughtReflection":"Reflections..."}
}

function SearchEvents(){
	_isSearching = true;

	var date = $('#eventSearchDate').val();
	var topic = $('#eventTagSort :selected').text();
	if(topic=="- Tag -"){
		topic = "";
	}
	var searchData = { userID: _user.ID, Tag: topic, Date: date };

	if(date === "" && topic === ""){
		ShowError('Please enter search criteria.');
		return;
	}

	ShowLoader();

	$.ajax({
		type: "GET",
		url: config.Path + '/ftd/search',
		data: searchData
	}).done(function(data){

		if(data=== null){
			HandleError('ftd/search returned null');
			return;
		}

		var html = '';

		if (data.length == 0){
			html = "<p>No events match your search criteria...</p>";
		}
		else {
			html = BuildEventListHtml(data);
		}

		$('#eventSearchResults').html(html);

		SetupEventListEvents();

		HideLoader();
	}); //end .done

}

function SetupActionEvents() {
	$('.newActionExamine').off();
	$('.newActionExamine').on('click', function(){
		_actionID = $(this).closest('.newAction').attr('id');
		var text = $(this).closest('.newAction').find('.hdnActionOverflow').val();
		$('#oldActionGoesHere').html(text);
		GetPositiveActions();
		MovePageLeft('#pageNewPositiveActions', _currentPage);
	});

	$('.newActionEdit').off();
	$('.newActionEdit').on('click', function(){
		var row = $(this).closest('.newAction');
		_isEditingAction = true;

		_actionID = row.attr('id');
		var text = row.find('.hdnActionOverflow').val();

		$('#whatDidIDoForm').removeClass('displayNone');
		$('#feelingsAddNewActionBtn').addClass('displayNone');

		ActionsPositiveOrNegativeCheckboxes();

		$('#feelingsActionsText').val(text);

		if(row.find('.text').hasClass('positive')){
			$('#feelingActionPositive').prop('checked', true);
		} else {
			$('#feelingActionNegative').prop('checked', true);
		}
	});
}

function SetupEditActions(){
	var html = "";
	var event = GetEventFromStorage(_eventID);

	if (event.Actions.length == 0) {
		$('#whatDidIDoForm').removeClass('displayNone');
		$('#feelingsAddNewActionBtn').addClass('displayNone');
	}
	else {
		$('#whatDidIDoForm').addClass('displayNone');
		$('#feelingsAddNewActionBtn').removeClass('displayNone');
	}

	for(var i=0; i < event.Actions.length; i++){
		var action = event.Actions[i];

		html += BuildNewActionHtml(action.ID, action.Rating, action.Text);
	}

	$('#newActionsGoHere').html(html);

	$('#actionsReflectionText').val(event.ActionReflection);

	SetupActionEvents();
}

function SetupEditFeelings(){
	var event = GetEventFromStorage(_eventID);


	if(event.Feelings === null || event.Feelings.length==0){
		return;
	}

	var feeling = event.Feelings[0];
	$('#selectedFeelingsGoHere').html(feeling.Feelings);

	$('#intensitySelect').val(feeling.Intensity);
	$('#feelingsSymptomsText').val(feeling.Symptoms);
	$('#eventDegreeSelect').val(feeling.DegreeBothered);

	if(feeling.Feelings === null){
		return;
	}
	var feelingsArray = feeling.Feelings.split(", ");

	for(var i=0; i < feelingsArray.length; i++){
		var found = false;
		var f = feelingsArray[i];

		$('#howDidIFeelCheckboxes').find('input').each(function(){
			if($(this).data('how-type') == f){
				$(this).prop('checked', true);
				found = true;
				return false;
			}
		});

		if (!found)
			$('#howOtherText').val(f);
	}



}

function SetupEditThoughts(){
	var event = GetEventFromStorage(_eventID);

	if (event.Thoughts.length > 0) {
		$('#newThoughtsForm').addClass('displayNone');
		$('#addNewThoughtBtn').removeClass('displayNone');
	}
	else {
		$('#newThoughtsForm').removeClass('displayNone');
		$('#addNewThoughtBtn').addClass('displayNone');
	}

	for(var i=0; i < event.Thoughts.length; i++){
		var thought = event.Thoughts[i];

		var html = BuildNewThoughtHtml(thought.ID, thought.Rating, thought.Text)
		$('#newThoughtsGoHere').append(html);
	}

	$('#thoughtReflectionText').val(event.ThoughtReflection);

	SetupThoughtEvents();
}


function ActionCancel() {
    //   $('#hdnActionID').val('');
}

function DeleteEvent() {
    ShowLoader();
   
    $.ajax({
        type: "Get",
        url: config.Path + '/ftd/deleteftdevent',
        data: {id:_eventID}
    }).done(function (data) {
        //alert(JSON.stringify(data));
        if (data === null) {
            HandleError("ftd/deleteftdevent returned null");
            return;
        }

        GetEvents(function () {
            if ($('#' + _eventID).length > 0)
                $('#' + _eventID).remove();
            for (var i = 0; i < _allEventsStorage.length; i++) {
                if (_allEventsStorage[i].ID == _eventID) {
                    _allEventsStorage.splice(i, 1);
                    break;
                }
            }
        });

        ShowSuccess("Event Deleted.");
        HideLoader();
    });
  
}

function SetupEventListEvents() {
	$('.eventRow').off();
	$('.eventRow').on('click', function(){
		_eventID = $(this).attr('id');
		var event = GetEventFromStorage(_eventID);

		ShowEventText(event);
		LoadFTDImage(event);

		// EditCompletedEvent(data);
		_previousFeelingsPage = _currentPage;

		$('.ftdImage').show();
		$('#goToSummaryBtn').removeClass('displayNone');

		MovePageLeft('#pageFeelingsNewEventPage', _currentPage);
	});
	$('.deleteView').off();
	$('.deleteView').on('click', function (event) {
	    var el = $(this).closest(".eventRow");
	    _eventID = el.attr('id');
	    ShowConfirm("<strong>Are you sure you want to delete this entry?</strong>", DeleteEvent, ActionCancel);
	    event.stopPropagation();
	
	});
}

function SetupPositiveActionEvents() {
	$('.newPositiveActionEdit').off();
	$('.newPositiveActionEdit').on('click', function(){
		var row = $(this).closest('.newPositiveAction');
		_isEditingPositiveAction = true;

		_positiveActionID = row.attr('id');
		var text = row.find('.text').html();

		$('#newPositiveActionForm').removeClass('displayNone');
		$('#feelingsAddNewPositiveActionBtn').addClass('displayNone');

		$('#feelingsWhatDidIDoText').val(text);

		var editingPositiveActionObject = GetPositiveActionFromStorage(_positiveActionID);

		$('#feelingsDoable').prop("checked", editingPositiveActionObject["Doable"]);
		$('#feelingsHelpful').prop("checked", editingPositiveActionObject["Helpful"]);
		$('#feelingsAppropriate').prop("checked", editingPositiveActionObject["Appropriate"]);

		$('#feelingsWhatDidIDoText').focus();

	}); // end editing a positive action
}

function SetupThoughtEvents(){
	$('.newThoughtExamine').off();
	$('.newThoughtExamine').on('click', function(){
		_thoughtID = $(this).closest('.newThought').attr('id');
		var text = $(this).closest('.newThought').find('.newThoughtOverflow').val();

		$('#whatIThoughtFeelings').html('<div class="font300">' + text + '</div>');

		var examineThoughtObject = GetThoughtFromStorage(_eventID, _thoughtID);

		// Set the values on the page for Examine the Thought
		if (examineThoughtObject.Believe !== null)
			$('#howMuchIBelieveSelect').val(examineThoughtObject.Believe);

		$('#otherViewsText').val(examineThoughtObject.OtherPoints);
		$('#thoughtFactsText').val(examineThoughtObject.Facts);
		$('#thoughtBalancedText').val(examineThoughtObject.Balanced);
		// Set the values for the Examine the Thought Popups (2)

		if (examineThoughtObject.HowThoughtsFeel !== null){
			var thoughtsFeelArray = examineThoughtObject.HowThoughtsFeel.split(", ");
			BuildBadFeelingsHtml(thoughtsFeelArray);

			for(var t=0; t < thoughtsFeelArray.length; t++){
				var found = false;
				var thought = thoughtsFeelArray[t];

				$('#howThoughtsFeelCheckboxes').find('input').each(function(){
					//alert($(this).data('thoughts-type') + ' == ' + thought);
					if($(this).data('thoughts-type') == thought){
						$(this).prop('checked', true);
						found = true;
						return false;
					}
				});

				if (!found)
					$('#thoughtsOtherText').val(thought);
			}
		}


		// BE SURE TO CLEAR ALL FORMS!!!! ************************************

		if (examineThoughtObject.HowWantFeel !== null) {
			var wantFeelArray = examineThoughtObject["HowWantFeel"].split(", ");
			BuildGoodFeelingsHtml(wantFeelArray);

			for(var w=0; w<wantFeelArray.length; w++){
				var want = wantFeelArray[w];
				var found = false;

				$('#howWantFeelCheckboxes').find('input').each(function(){
					if($(this).data('want-type') == want){
						$(this).prop('checked', true);
						found = true;
						return false;
					}
				});

				if (!found)
					$('#wantFeelOtherText').val(want);
			}
		}

		if(examineThoughtObject.Assumption == "Yes"){
			$('#assumptionYes').prop('checked', true);
		} else if (examineThoughtObject.Assumption == "No"){
			$('#assumptionNo').prop('checked', true);
		}

		MovePageLeft('#pageChallengeTheThoughtFeelings', _currentPage);
	});

	$('.newThoughtEdit').off();
	$('.newThoughtEdit').on('click', function(){

		_isEditingThought = true;
		$('#newThoughtPositive').prop('checked', false);
		$('#newThoughtNegative').prop('checked', false);

		_thoughtID = $(this).closest('.newThought').attr('id');
		var thoughtText = $(this).closest('.newThought').find('.newThoughtOverflow').val();
		var textElement = $(this).closest('.newThought').find('.text');

		$('#newThoughtsForm').removeClass('displayNone');
		$('#addNewThoughtBtn').addClass('displayNone');

		PositiveOrNegativeCheckboxes();

		$('#newThoughtText').val(thoughtText);

		if(textElement.hasClass('positive')){
			$('#newThoughtPositive').prop('checked', true);
		} else {
			$('#newThoughtNegative').prop('checked', true);
		}

		$('#newThoughtText').focus();
	});
}

function ShowEventText(event){
	$('#theEventTagGoesHere').html(event.Tag);
	$('#addEventForm').addClass('displayNone');
	$('#editEventBtn').removeClass('displayNone');
	$('#viewEvent').removeClass('displayNone');

	var max = 30
	if (event.Text.length > max){
		cleanedText = jQuery.trim(event.Text).substring(0, max).split(" ").slice(0, -1).join(" ") + "...";
		// SHOW POPUP ICON AND PUT THE UNTRIMMED TEXT ON IT ***********
		$('#theEventTextGoesHere').html('<div>' + cleanedText + '<span class="right blue" id="eventTextPopup">View More</span></div>');
		$('#overflowEventTextHere').html(event.Text);

		$('#eventTextPopup').on('click', function(){
			MovePageUp('#pageFeelingsEventTextPopUp', '#pageFeelingsNewEventPage');

			$('#eventTextPopupFinished').on('click', function(){
				MovePageDown('#pageFeelingsNewEventPage', '#pageFeelingsEventTextPopUp');
			});
		});
	} else {
		$('#theEventTextGoesHere').html('<div>' + event.Text + '</div>');
	}
}

function StartNewEvent() {
	ResetFeelingsTool();
	setTimeout(function(){$('#feelingsEventText').focus();}, 500);
	$('.ftdImage').hide();

	if (_isEmbeddedChangeTool) {
		$('#cancelEventBtn').hide();
		$('#btnEventDone').hide();
		$('#btnFeelingEmbedDone').show();
	}
	else {
		$('#cancelEventBtn').show();
		$('#btnEventDone').show();
		$('#btnFeelingEmbedDone').hide();
	}
}


