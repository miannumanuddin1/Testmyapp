var _dialogID = null;
var _clientID = null;
var _conversationID = null;
var _isProcessing = false;
var _wFavorites = [];
var _isWatsonArticle = false, _returnToFavorites = false;
var _activeVATSControl = null;
var _activeVATSPage = null;
var _favHeader = "Videos";
var _favType = "WatsonVideo";

function InitializeWatson(){
	ResizeWatson();

	$('#txtWatsonChat').keyup(function(e){
		if ($(this).val() == '')
			return;

		if (e.keyCode == 13){
			Converse();
		}
	});

	$('#pageExternalLink .closeExternal').on('click', function(){
		CloseExternalPage();
	});

	$('#btnFeedbackYes').on('click', function(){
		SaveVATSFeedback(true);
	});

	$('#btnFeedbackNo').on('click', function(){
		SaveVATSFeedback(false);
	});

	$('#btnVATSPageFeedbackYes').on('click', function(){
		SaveVATSPageFeedback(true);
	});

	$('#btnVATSPageFeedbackNo').on('click', function(){
		SaveVATSPageFeedback(false);
	});

	$('#btnCancelWatsonFeedback').on('click', function(){
		RestartWatson();
		MovePageRight('#pageWatson', _currentPage, function(){
			$('#txtWatsonChat').focus();
		});
	});

	$('#btnSendWatsonFeedback').on('click', function(){
		var txt = $('#txtWatsonFeedback').val();
		
		if (txt.trim() === ''){
			ShowError('Please enter some feedback.');
			return;
		}

		MovePageRight('#pageWatson', _currentPage, function(){
			$('#txtWatsonChat').focus();
		});

		$.ajax({
			url: config.Path + '/watson/sendfeedback',
			type: 'POST',
			data: { userID: _user.ID, pageID: _activeVATSPage.ID, feedback: txt}
		}).done(function(data){
			_activeVATSPage = null;

			ShowSuccess('Thank you for your feedback!');

			if (data === null){
				HandleError('watson/sendfeedback returned null');
				return;
			}
		});
	});

    LoadWatsonFavorites(function(){
    	BuildFavoriteList();
    });

    // FAVORITES PAGE STUFF
    
    $('#btnFavVideo').on('click', function(){
    	_favHeader = "Videos";
		_favType = "WatsonVideo";
		$('.favButton').removeClass('active');
		$(this).addClass('active');
    	BuildFavoriteList();
    });

    $('#btnFavArticle').on('click', function(){
    	_favHeader = "Articles";
		_favType = "WatsonInternalArticle";
		$('.favButton').removeClass('active');
		$(this).addClass('active');
    	BuildFavoriteList();
    });

    $('#btnFavTips').on('click', function(){
    	_favHeader = "Tips";
		_favType = "WatsonTips";
		$('.favButton').removeClass('active');
		$(this).addClass('active');
    	BuildFavoriteList();
    });

    $('#btnFavInternet').on('click', function(){
    	_favHeader = "External Articles";
		_favType = "WatsonExternalLink";
		$('.favButton').removeClass('active');
		$(this).addClass('active');
    	BuildFavoriteList();
    });
}

function AnimateLeft(line, index, callback){
	var time = 0;
	if (index == 0) {
		time = 200;
	}
	else {
		time = 1000;
	}

	setTimeout(function(){ 
		line.addClass('showChatLeft');
		$('.discussion').scrollTo(line, 200, { axis: 'y', offset: { top: 20 } });

		if (callback){
			callback();
		}
	 }, time);
}

function AnimateRight(x, callback){
	setTimeout(function(){ 
		x.addClass('showChatRight');
		$('.discussion').scrollTo(x, 200, { axis: 'y', offset: { top: 20 } });

		if (callback){
			callback();
		}

	}, 100);
}

function BuildVATSFooterHtml(controlID){
	var html = '<div class="vatsFooter row">';
	var fav = GetFavorite(controlID);

	if (fav != null) {
		html += '<div class="col-xs-6 fav saved"><img src="img/assets/iconFav.png" /></div>';	
	}
	else {
		html += '<div class="col-xs-6 fav"><img src="img/assets/iconFav-Grey.png" /></div>';	
	}

	html += '<div class="col-xs-6"><div class="right arrow"><i class="fa fa-arrow-right"></i></div>';

	html += '</div>';

	return html;
}

function BuildFavoritesListFooterHtml(controlID){
	var html = '<div class="vatsFooter row">';
	html += '<div class="col-xs-6 removeFav">Remove</div>';	
	html += '<div class="col-xs-6"><div class="right arrow"><i class="fa fa-arrow-right"></i></div>';

	html += '</div>';

	return html;
}

function CloseExternalPage(){
	ShowHeader(function(){
		AllowScroll();
		var page = '#pageVATS';

		if (_returnToFavorites){
			page = '#pageFavs';
		}

		MovePageRight(page, _currentPage, function(){
			var frame = $('#pageExternalLink .frame');
			frame.attr('src', '');

			if (_returnToFavorites){
				_returnToFavorites = false;
			}
			else{
				$('#pageVATSFeedback .helpText').html('Was this article helpful?');
				MovePageUp('#pageVATSFeedback', null, true);
			}
		});
	});
}

function Converse(){
	if (_isProcessing)
		return;

	var input = $('#txtWatsonChat').val();
	var isTesting = false;

	if (input.toLowerCase() == 'vats')
		isTesting = true;

	var id = CreateGuid();
	var html = '<div id="' + id + '" class="userResponse">';
	html += '<img class="chatRight" src="img/assets/chatRight.png" />';
	html += '<div class="text">' + input.trim() + '</div>';
	html += '</div>';

	$('#pageWatson .discussion').append(html);
	var line = $('#' + id);
	AnimateRight(line, function(){
		if (isTesting){
			LoadVATS('test');
		}
	});

	$('#txtWatsonChat').val('');

	if (isTesting)
		return;

	ShowLoader();
	_isProcessing = true;

	$.ajax({
		url: config.Path + '/watson/converse',
		data: { DialogID: _dialogID, ConversationID: _conversationID, ClientID: _clientID, Input: input },
		type: 'POST'
	}).done(function(data){
		HideLoader();

		if (data === null) {
			HandleError('Watson blew up...');
			return;
		}

		ProcessResponse(data.Response);
		_isProcessing = false;
	});
}

function GetFavorite(controlID){
	for (var i = 0; i < _wFavorites.length; i++) {
		var fav = _wFavorites[i];
		if (fav.ControlID == controlID)
			return fav;
	}

	return null;
}

function BuildFavoriteList(){
	$('#favListWrapper').slideUp(300, function(){
		$('#favoriteType').html(_favHeader);
		$('#favList').html('');
		var hasFavs = false;

		for (var i = 0; i < _wFavorites.length; i++) {
			var fav = _wFavorites[i];
			var c = fav.Control;

			if (c.Type != _favType)
				continue;

			hasFavs = true;

			switch (c.Type){
				case 'WatsonVideo':
					RenderWatsonVideo(c, true);
					break;
				case 'WatsonExternalLink':
					RenderWatsonExternalLink(c, true);
					break;
				case 'WatsonInternalArticle':
					RenderWatsonInternalArticle(c, true);
					break;
				case 'WatsonTips':
					RenderWatsonTips(c, true);
					break;
			}
			
		}

		if (!hasFavs){
			$('#favList').html('You have not saved any favorites of this type yet.');
		}

		$('#favListWrapper').slideDown(300);

	});
}

function LoadFavoriteFooterEvents(id, controlID){
	var e = $('#' + id);
	var fav = e.find('.removeFav');

	$(fav).on('click', function(){
		ShowLoader();

		$.ajax({
			url: config.Path + '/watson/deletefavorite',
			type: 'POST',
			data: { userID: _user.ID, controlID: controlID }
		}).done(function(data){
			HideLoader();

			if (data === null){
				HandleError('watson/deletefavorite returned null');
				return;
			}

			LoadWatsonFavorites(function(){
				BuildFavoriteList();
			});
		});
	});
}

function LoadFooterEvents(id, controlID){
	var e = $('#' + id);
	var fav = e.find('.fav');

	$(fav).on('click', function(){
		ShowLoader();
		var e = $(this);

		if (e.hasClass('saved')) {
			$.ajax({
				url: config.Path + '/watson/deletefavorite',
				type: 'POST',
				data: { userID: _user.ID, controlID: controlID }
			}).done(function(data){
				HideLoader();

				if (data === null){
					HandleError('watson/deletefavorite returned null');
					return;
				}

				LoadWatsonFavorites(function(){ BuildFavoriteList(); });
				e.find('img').attr('src', 'img/assets/iconFav-Grey.png');
				e.removeClass('saved');
			});
		}
		else {
			$.ajax({
				url: config.Path + '/watson/addfavorite',
				type: 'POST',
				data: { userID: _user.ID, controlID: controlID }
			}).done(function(data){
				HideLoader();

				if (data === null){
					HandleError('watson/addfavorite returned null');
					return;
				}

				LoadWatsonFavorites(function(){ BuildFavoriteList(); });
				e.find('img').attr('src', 'img/assets/iconFav.png');
				e.addClass('saved');
			});
		}
	});
}

function LoadVATS(linkID){
	$.ajax({
		url: config.Path + '/watson/getvats?linkID=' + linkID
	}).done(function(data){
		if (data === null){
			HandleError('watson/getvats returned null');
			return;
		}

		_activeVATSPage = data;

		// animations look cooler with a bit of delay
		setTimeout(function(){
			ShowVATS();
		}, 500);
		
	});
}

function LoadWatsonFavorites(callback){
	_wFavorites = [];

	$.ajax({
    	url: config.Path + '/watson/getfavorites',
    	data: { userID: _user.ID }
    }).done(function(data){
    	if (data === null){
    		HandleError('watson/getfavorites returned null');
    	}
    	else{
    		for (var i = 0; i < data.length; i++) {
	    		_wFavorites.push(data[i]);
	    	}
    	}

    	if (callback)
    		callback();
    })
}

function ProcessResponse(response){

	if (typeof response == "undefined")
		return;

	var isEnd = false;

	if (response.length !== 0) {
		var id = CreateGuid();
		var html = '<div id="' + id + '" class="watsonResponse">';

		for (var i = 0; i < response.length; i++) {
			var r = response[i].trim();
			if (r == '')
				continue;

			console.log(r);

			if (r.indexOf('<end>') != -1) {
				console.log('VATS');
				isEnd = true;
				break;
			}

			html += '<div class="line"><img class="chatLeft" src="img/assets/chatLeft.png" />';
			html += '<div class="text">' + r + '</div>';
			html += '</div>';
		}

		html += '</div>';
		$('#pageWatson .discussion').append(html);

		var lines = $('#' + id + ' .line');
		for (var i = 0; i < lines.length; i++) {
			var line = $(lines[i]);

			AnimateLeft(line, i);				
		};
	}

	// we only need to check the variables when the response tells us we are done with the branch.
	if (isEnd){
		$.ajax({
			url: config.Path + '/watson/getprofile',
			type: 'GET',
			data: { dialogID: _dialogID, clientID: _clientID }
		}).done(function(data){
			if (data === null){
				HandleError("watson/getprofile returned null...");
				return;
			}

			ProcessVariables(data.name_values);
		});
	}
}

function ProcessVariables(variables){
	for (var i = 0; i < variables.length; i++) {
		var variable = variables[i];
		switch (variable.name){
			case 'LinkID':
				LoadVATS(variable.value);
			default:
				console.log(variable.name + " : " + variable.value);
		}
	}
}

function RenderWatsonExternalLink(control, isFavoriteList){
	var id = CreateGuid();

	var html = '<div class="vatsControl vatsExternal" id="' + id + '">';
	html += '<div class="row">';
	html += '<div class="col-xs-3"><img class="icon" src="img/assets/iconWatsonExternal.png" /></div>';
	html += '<div class="col-xs-9">';
	html += '<div class="name ">' + control.Prompt + '</div>';
	html += '<div class="description">' + control.Action + '</div>';
	html += '</div></div>';

	if (isFavoriteList){
		html += BuildFavoritesListFooterHtml(control.ID);
		html += '</div>';
		$('#favList').append(html);
		LoadFavoriteFooterEvents(id, control.ID);
	}
	else {
		html += BuildVATSFooterHtml(control.ID);
		html += '</div>';

		$('#vats').append(html);
		LoadFooterEvents(id, control.ID);
	}

	$('#' + id + ' .icon, #' + id + ' .arrow').on('click', function(){
		if (!isFavoriteList)
			_activeVATSControl = control;
		else
			_returnToFavorites = true;

		ShowWatsonExternalLink(control);
	});
}

function RenderWatsonInternalArticle(control, isFavoriteList){
	var id = CreateGuid();

	var html = '<div class="vatsControl vatsInternal" id="' + id + '">';
	html += '<div class="row">';
	html += '<div class="col-xs-3"><img class="icon" src="img/assets/iconWatsonArticle.png" /></div>';
	html += '<div class="col-xs-9">';
	html += '<div class="name ">' + control.Prompt + '</div>';
	html += '<div class="description">' + control.Action + '</div>';
	html += '</div></div>';

	if (isFavoriteList){
		html += BuildFavoritesListFooterHtml(control.ID);
		html += '</div>';
		$('#favList').append(html);
		LoadFavoriteFooterEvents(id, control.ID);
	}
	else {
		html += BuildVATSFooterHtml(control.ID);
		html += '</div>';

		$('#vats').append(html);
		
		LoadFooterEvents(id, control.ID);
	}

	$('#' + id + ' .icon, #' + id + ' .arrow').on('click', function(){
		_isWatsonArticle = true;
		
		if (isFavoriteList)
			_returnToFavorites = true;
		else
			_activeVATSControl = control;

		StartWatsonArticle(control.Value); // in contentengine
	});
}

function RenderWatsonTips(control, isFavoriteList){
	var id = CreateGuid();

	var html = '<div class="vatsControl vatsTips" id="' + id + '">';
	html += '<div class="row">';
	html += '<div class="col-xs-3"><img class="icon" src="img/assets/iconWatsonTip.png" /></div>';
	html += '<div class="col-xs-9">';
	html += '<div class="name ">' + control.Prompt + '</div>';
	html += '<div class="description">' + control.Action + '</div>';
	html += '</div></div>';

	if (isFavoriteList) {
		html += BuildFavoritesListFooterHtml(control.ID);
		html += '</div>';
		$('#favList').append(html);
		LoadFavoriteFooterEvents(id, control.ID);
	}
	else {
		html += BuildVATSFooterHtml(control.ID);
		html += '</div>';

		$('#vats').append(html);
		LoadFooterEvents(id, control.ID);
	}

	$('#' + id + ' .icon, #' + id + ' .arrow').on('click', function() {
		if (isFavoriteList){
			ShowTipSheet(control.Value, 'favorite');
		}
		else {
			ShowTipSheet(control.Value, 'watson');
			_activeVATSControl = control;
		}
	});
}

function RenderWatsonVideo(control, isFavoriteList){
	var id = CreateGuid();
	
	var html = '<div class="vatsControl vatsVideo" id="' + id + '">';
	html += '<div class="row">';
	
	if (isFavoriteList){
		// original design...
		html += '<img class="play" src="img/assets/iconPlay.png" />';
		html += '<div class="col-xs-5"><img class="placeholder" src="' + control.Placeholder + '" /></div>';
		html += '<div class="col-xs-7">';
	}
	else {
		// updated design
		html += '<div class="col-xs-3"><img class="icon" src="img/assets/iconWatsonVideo.png" /></div>';
		html += '<div class="col-xs-9">';
	}

	html += '<div class="name ">' + control.Prompt + '</div>';
	html += '<div class="description">' + control.Action;
	html += '<div class="length">' + control.Code + '</div></div>';
	html += '</div></div>';

	if (isFavoriteList) {
		html += BuildFavoritesListFooterHtml(control.ID);
		html += '</div>';
		$('#favList').append(html);

		var video = $('#' + id);
	    var path = control.Value;
	    var vimeo =  path.substr(path.lastIndexOf('/') + 1);

		var play = video.find('.play');
	    VideoClick(play, vimeo, path, 'favorite');
	    play.on('click');

	    play = video.find('.arrow');
	    VideoClick(play, vimeo, path, 'favorite');
	    play.on('click');

	    LoadFavoriteFooterEvents(id, control.ID);
	}
	else {
		html += BuildVATSFooterHtml(control.ID);
		html += '</div>';

		$('#vats').append(html);

		var video = $('#' + id);
	    var path = control.Value;
	    var vimeo =  path.substr(path.lastIndexOf('/') + 1);

		var play = video.find('.icon');
	    VideoClick(play, vimeo, path, 'watson');
	    play.on('click', function(){
	    	ViewWatsonVideo(control);
	    });

	    play = video.find('.arrow');
	    VideoClick(play, vimeo, path, 'watson');
	    play.on('click', function(){
	    	ViewWatsonVideo(control);
	    });

	    LoadFooterEvents(id, control.ID);
	}
}

function ResizeWatson(){
	var wh = $(window).height();
	var bottomH = 95;
	var header = 78;
	var watsonH = wh - header - bottomH;

	$('#pageWatson .discussion').css('height', watsonH + 'px');

	var linkH = wh - 57;
	$('.externalFrameWrapper').css('height', linkH + 'px !important');
	$('.externalFrameWrapper').css('width', $(window).width() + 'px !important');
}

function RestartWatson(){
	_clientID = null;
	_conversationID = null;

	ShowLoader();
	StartNewConversation();
}

function StartNewConversation(id){
	var list = [];
    var nv = { name: "FirstName", value: _user.FirstName};
    list.push(nv);

    var postData = { dialog_id: _dialogID, name_values: list }
    
	$.ajax({
		url: config.Path + '/watson/saveprofile',
		type: 'POST',
		data: postData
	}).done(function(data){
		if (data === null){
			HandleError('Watson SaveProfile returned null');
			return;
		}

		_clientID = data.client_id;
		console.log('Client ID: ' + _clientID);

		$.ajax({
			url: config.Path + '/watson/converse',
			data: { DialogID: _dialogID, ClientID: _clientID },
			type: 'POST'
		}).done(function(data){

			if (data === null) {
				HandleError('Watson Converse blew up...');
				return;
			}

			if (id){
				$('#' + id + ' .line').css('left', '-150%');
			}

			setTimeout(function(){
				if (id) {
					$('#pageWatson .discussion').html('');
				}
				
				_conversationID = data.ConversationID;

				ProcessResponse(data.Response);

				HideLoader();
			}, 400);
		});
	});
}

function SaveVATSFeedback(isHelpful) {
	MovePageDown(_currentPage, '#pageVATSFeedback', true, function(){
        $('#pageVATSFeedback').hide();
    });

	$.ajax({
		url: config.Path + '/watson/savevatsfeedback',
		type: 'POST',
		data: { controlID: _activeVATSControl.ID, userID: _user.ID, isHelpful: isHelpful }
	}).done(function(data){
		_activeVATSControl = null;

		if (data === null){
			HandleError('watson/savevatsfeedback returned null');
			return;
		}
	});
}

function SaveVATSPageFeedback(isHelpful) {
	RestartWatson();

	if (!isHelpful){
		MovePageLeft('#pageVATSEmail', _currentPage, function(){
			$('#txtWatsonFeedback').focus();
		});
	}
	else {
		MovePageRight('#pageWatson', _currentPage, function(){
			$('#txtWatsonChat').focus();
		});
	}

	$.ajax({
		url: config.Path + '/watson/savevatspagefeedback',
		type: 'POST',
		data: { pageID: _activeVATSPage.ID, userID: _user.ID, isHelpful: isHelpful }
	}).done(function(data){
		if (isHelpful)
			_activeVATSPage = null;

		if (data === null){
			HandleError('watson/savevatspagefeedback returned null');
			return;
		}
	});
}

function ShowWatsonExternalLink(control){
	HideHeader(); // in index.js
	$('#topLoader').show();
	NoScroll();

	var name = control.Prompt.substr(0, 35);
	var link = control.Value;
	$('#pageExternalLink .header .text').html('<a onclick="OpenExternalLink(\'' + link + '\');">' + name + '</a>');

	var wrapper = $('#pageExternalLink .externalFrameWrapper');
	var frame = $('#pageExternalLink .frame');
	wrapper.css('opacity', '.1');

	var linkH = $(window).height() - 57;
	$('#pageExternalLink .externalFrameWrapper, .externalFrameWrapper .scroller').css('height', linkH + 'px');
	wrapper.css('width', $(window).width() + 'px');
	
	$('.externalLoad').show();

	if (_isNative){
		var win = window.open( link, "_blank", "hidden=yes, location=yes" );
		win.addEventListener( "loadstop", function() {
		    $('.externalLoad').hide();
			wrapper.css('opacity', '1');
			$('#topLoader').hide();
			win.show();
		});

		win.addEventListener( "exit", function() {
		    CloseExternalPage();
		});
	}
	else {
		// guestimating...
		frame.css('height', '10000px');
		
		frame.on('load', function() {
			$('.externalLoad').hide();
			wrapper.css('opacity', '1');

			$('#topLoader').hide();
		});

		frame.attr('src', link);
	}
	
	MovePageLeft('#pageExternalLink', _currentPage);
}

function ShowVATS(){
	// guaranteeing sort order
    var controls = _activeVATSPage.Controls.sort(function(obj1, obj2) {
        return obj1.Order - obj2.Order;
    });

	$('#vats').html('');
	for (var i = 0; i < controls.length; i++) {
		var c = controls[i];

		switch (c.Type){
			case 'content':
                var html = RenderStaticContent(c);
                $('#vats').append(html);
                break;
            case 'header':
                var html = RenderHeader(c);
                $('#vats').append(html);
                break;
            case 'image':
                var html = RenderImage(c, true);
                $('#vats').append(html);
                break;
			case 'WatsonVideo':
				RenderWatsonVideo(c);
				break;
			case 'WatsonExternalLink':
				RenderWatsonExternalLink(c);
				break;
			case 'WatsonInternalArticle':
				RenderWatsonInternalArticle(c);
				break;
			case 'WatsonTips':
				RenderWatsonTips(c);
				break;
		}
	}

	MovePageLeft('#pageVATS', _currentPage);
}

function StartWatson() {
	ShowLoader();
	ShowyClose('#pageWatson', function(){
		$('#txtWatsonChat').focus();
	});

	var id = CreateGuid();
	var html = '<div id="' + id + '" class="watsonResponse">';
	html += '<div class="line"><img class="chatLeft" src="img/assets/chatLeft.png" />';
	html += '<div class="text">Be right with you...</div>';
	html += '</div></div>';

	$('#pageWatson .discussion').html(html);
	$('#' + id + ' .line').css('left', '15px');

 	$.ajax({
    	url: config.Path + '/watson/getdialog'
    }).done(function(data){
    	if (data == null){
    		// no dialog...
    		HandleError('there is no active dialog in watson...');
    		return;
    	}

    	_dialogID = data.DialogID;
    	LogInfo('Watson Initialized: ' + _dialogID);

    	StartNewConversation(id);
    });
}

function ViewWatsonVideo(control){
	_activeVATSControl = control;

	$('#closeVideo').one('click', function(){
		$('#pageVATSFeedback .helpText').html('Was this video helpful?');
		MovePageUp('#pageVATSFeedback', null, true);
	});
}



