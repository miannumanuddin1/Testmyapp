var _previsitFromDB;

function InitializeHealthCare(){

	$('#PVToolSubmit').on('click', function(){
		GatherPrevisitTool();
		// var datepicker = $('.datepicker').val();
	});

	$('#PVToolEmailDoctor').on('click', function(){
		MovePageUp('#pagePrevisitPopUp', '#pagePrevisitTool');
	});

	$('#previsitPopUpFinished').on('click', function(){
		MovePageDown('#pagePrevisitTool', '#pagePrevisitPopUp');
	});

	$('#PVToolAddQuestion').on('click', function(){
		$('#PVToolQuestionsGroup').append('<li class="PVToolQuestion"><input type="text" class="PVToolQuestionTextBox" /></li>');
	});

	$('#PVToolClose').on('click', function(){
		if (_isEmbeddedPrevisit){
			_isEmbeddedPrevisit = false;
			ShowNextPage(); // in contentengine...
			return;
		}
		
		ShowHomePage();
	});

	$('#PVToolBtn').on('click', function(){
		GetPrevisitTool();
		ShowyClose('#pagePrevisitTool');
		// $('.datepicker').focus();
	});

	var options = {
		date: new Date(),
		mode: 'date'
	};

}

// function SetDate(){
// 	 var today = moment("2014-11-11");
// 	 $('#PVToolDate').val(today);
// }

//this is the "SAVE" function
function GatherPrevisitTool(){
	var date = $('#PVToolDate').val();
	var eating = $('#PVToolEating').is(':checked');
	var sleeping = $('#PVToolSleeping').is(':checked');
	var activityLevel = $('#PVToolActivity').is(':checked');
	var social = $('#PVToolSocial').is(':checked');
	var smoking = $('#PVToolSmoking').is(':checked');
	var alcohol = $('#PVToolAlcohol').is(':checked');
	var stress = $('#PVToolStress').is(':checked');
	var mood = $('#PVToolMood').is(':checked');
	var anxious = $('#PVToolAnxious').is(':checked');
	var visitReason = $('#PVToolReason').val();
	var howLong = $('#PVToolHowLong').val();
	var symptoms = $('#PVToolSymptoms').val();
	var howBad = $('#PVToolHowBad option:selected').val();
	var medications = $('#PVToolMeds').val();
	var supplements = $('#PVToolSupplements').val();

	var tool = { UserID: _user.ID, UserDate: date, ChangesEating: eating, ChangesSleeping: sleeping, ChangesActivity: activityLevel,
	ChangesSocial: social, ChangesSmoking: smoking, ChangesAlcohol: alcohol, ChangesStress: stress, ChangesMood: mood,
	ChangesAnxious: anxious, ReasonForVisit: visitReason, GoingOn: howLong, Symptoms: symptoms, HowBad: howBad, Medications: medications,
	Supplements: supplements };

	// {"UserID":"75fa6360-7be9-4128-9328-c9698ffadf47","UserDate":"2015-06-04","ChangesEating":true,"ChangesSleeping":true,"ChangesActivity":false,
	// "ChangesSocial":false,"ChangesSmoking":false,"ChangesAlcohol":false,"ChangesStress":true,"ChangesMood":true,"ChangesAnxious":false,
	// "ReasonForVisit":"reason2","GoingOn":"asdfasdf","Symptoms":"asfsadfsad","HowBad":"3","Medications":"asfasdfsad","Supplements":"asfsad"}

	var questions = [];
	$('#PVToolQuestionsGroup').find('input').each(function(){
		var text = $(this).val();
		questions.push({ Question: text });
	});

	var toolsMatch = PrevisitToolCompare(tool);
	var questionsMatch = PrevisitQuestionsCompare(questions);

	if(toolsMatch && questionsMatch){
		if (_isEmbeddedPrevisit){
			_isEmbeddedPrevisit = false;
			ShowNextPage(); // in contentengine...
		}
		else
			ShowHomePage();
	} else {

		$.ajax({
	        type: "POST",
        	url: config.Path + '/previsit/savetool',
	        data: tool
	    }).done(function(data){
			if (data === null){
				HandleError('Save Previsit tool returned null');
				return;
			}
			questions = [];

			$('#PVToolQuestionsGroup').find('input').each(function(){
				var text = $(this).val();
				questions.push({ PrevisitToolID: data.ID, Question: text });
			});

			$.ajax({
			url: config.Path + '/previsit/savequestions',
				data: JSON.stringify(questions),
				contentType: 'application/json; charset=utf-8',
				type: 'POST'
			}).done(function(data){
				ShowSuccess('Form saved.');
				GetPrevisitTool();
			});

			if (_isEmbeddedPrevisit){
				_isEmbeddedPrevisit = false;
				ShowNextPage(); // in contentengine...
			}
			else
	        	ShowHomePage();
	    });
	} // END ELSE

// RETURNED DATA FROM POST:

//{"Questions":[{"Question":"q2",},{"Question":"q1"}],"UserDate":"tomorrow","ChangesEating":true,"ChangesSleeping":false,
//"ChangesActivity":false,"ChangesSocial":true,"ChangesSmoking":false,"ChangesAlcohol":true,"ChangesStress":false,"ChangesMood":true,
//"ChangesAnxious":false,"ReasonForVisit":"no reason","GoingOn":"n/a","Symptoms":"none","HowBad":2,"Medications":"all of them",
//"Supplements":"some"}
}

function PrevisitToolCompare(tool){

	if(_previsitFromDB === null){
		return false;
	}

	var items = ['ChangesEating', 'ChangesSleeping', 'ChangesActivity', 'ChangesSocial', 'ChangesSmoking', 'ChangesAlcohol',
	'ChangesStress', 'ChangesMood', 'ChangesAnxious', 'ReasonForVisit', 'GoingOn', 'Symptoms', 'HowBad', 'Medications',
	'Supplements'];
	var length = items.length;
	var i = 0;

	for(i=0; i<length; i++){
		if(tool[items[i]] != _previsitFromDB[items[i]]){
			return false;
		}
	}
	return true;
}

function PrevisitQuestionsCompare(questions){
	if(_previsitFromDB===null){ return false; }
	if(questions.length != _previsitFromDB['Questions'].length){
		return false;
	}

	var length = questions.length;
	var i = 0;
	for(i=0; i<length; i++){
		if(questions[i]['Question'] != _previsitFromDB['Questions'][i]['Question']){
			return false;
		}
	}
	return true;
}

function GetPrevisitTool(){
	$.ajax({
		type: "GET",
		url: config.Path + '/previsit/gettool',
		data: { UserID: _user.ID }
	}).done(function(data){
		_previsitFromDB = data;
		if(data===null){
			var todaysDate = moment().format("YYYY-MM-DD");
	 		$('#PVToolDate').val(todaysDate);
		} else {
			BuildPrevisitTool(data);
		}
	});
}

function BuildPrevisitTool(data){

	$('#PVToolDate').val(data.UserDate);
	$('#PVToolEating').prop('checked', data.ChangesEating);
	$('#PVToolSleeping').prop('checked', data.ChangesSleeping);
	$('#PVToolActivity').prop('checked', data.ChangesActivity);
	$('#PVToolSocial').prop('checked', data.ChangesSocial);
	$('#PVToolSmoking').prop('checked', data.ChangesSmoking);
	$('#PVToolAlcohol').prop('checked', data.ChangesAlcohol);
	$('#PVToolStress').prop('checked', data.ChangesStress);
	$('#PVToolMood').prop('checked', data.ChangesMood);
	$('#PVToolAnxious').prop('checked', data.ChangesAnxious);
	$('#PVToolReason').val(data.ReasonForVisit);
	$('#PVToolHowLong').val(data.GoingOn);
	$('#PVToolSymptoms').val(data.Symptoms);
	$('#PVToolHowBad').val(data.HowBad);
	$('#PVToolMeds').val(data.Medications);
	$('#PVToolSupplements').val(data.Supplements);

	var i = 0;
    var length = data.Questions.length;
    if(length != 0){
    	$('#PVToolQuestionsGroup').html(""); //If you GET any PA's from the DB, remove the blank text box from the PA Tool page.
    }
    for(i=0; i<length; i++){
    	$('#PVToolQuestionsGroup').append('<li class="PVToolQuestion"><input type="text" value="' + data.Questions[i].Question + '" class="PVToolQuestionTextBox" /></li>')
    }

}

