var _matchedGroup = [];
var _pleasantFromDB;
var _matchingFromDB;

function InitializeMatching(){
	$('#matchingToolBtn').on('click', function(){
		GetMatchingTool();
		ShowyClose('#pageMatchingHome')
	});

	$('#meviiMatchingBtn').on('click', function(){
		GatherMatchingTop3();
	});

	$('.matchingBtn').on('click', function(){
		if($(this).hasClass('opacity50')){
			$(this).removeClass('opacity50');
		} else {
			$(this).addClass('opacity50');
		}
	});

	$('#matchingPrev').on('click', function(){
		MovePageRight('#pageMatchingHome', _currentPage);
	});

	$('#matchingSaveBtn').on('click', function(){
		SaveMatchingTool();
	});

	$('#matchingFinishedPrev').on('click', function(){
		MovePageRight('#pageMatchingSecond', _currentPage);
	});

	$('#matchingFinishedBtn').on('click', function(){
		// MovePageLeft('#rightMenu', _currentPage); // needs to be fixed.  leaves a blank page underneath menu
		ShowHomePage();
	});
	$('#stressReductionInfo').on('click', function(){
		MovePageUp('#pageMatchingPopUp', '#pageMatchingSecond');
		BuildPopUpHTML('stress');
	});
	$('#relaxationInfo').on('click', function(){
		MovePageUp('#pageMatchingPopUp', '#pageMatchingSecond');
		BuildPopUpHTML('relax');
	});
	$('#mindfulnessInfo').on('click', function(){
		MovePageUp('#pageMatchingPopUp', '#pageMatchingSecond');
		BuildPopUpHTML('mindful');
	});
	$('#matchingPopUpFinished').on('click', function(){
		MovePageDown('#pageMatchingSecond', '#pageMatchingPopUp');
	});
}

function GatherMatchingTop3(){
	_matchedGroup = [];
	$('#matchingGroup').children('div').each(function(){
		var title = $(this).children('.matchingTitle').html();
		if(!$(this).hasClass('opacity50')){
			_matchedGroup.push(title); // Gathering three stressful situations from home page
		}
	});
	if(_matchedGroup.length != 3){
		ShowError("Please choose 3.")
	} else{
		SetMatchingTitles();
		MovePageLeft('#pageMatchingSecond', _currentPage);
	}
}

function GetMatchingTool(){

	$.ajax({
        type: "GET",
        url: config.Path + '/matching/gettool',
        data: { UserID: _user.ID }
    }).done(function(data){
    	if(data===null){
    		return;
    	}
    	$('#matchingGroup').children('div').each(function(){

		_matchingFromDB = data;

		var title = $(this).children('.matchingTitle').html();
			if(title == data["Stress1"]){
				$(this).removeClass('opacity50');
			} else if(title == data["Stress2"]){
				$(this).removeClass('opacity50');
			} else if(title == data["Stress3"]){
				$(this).removeClass('opacity50');
			} else {
				return;
			}
    	});
    	SetMatchingDropBoxes(data);
	});
}

function SetMatchingDropBoxes(data){

	$('#matchingDrop1').val(data["Choice1"]);
	$('#matchingDrop2').val(data["Choice2"]);
	$('#matchingDrop3').val(data["Choice3"]);
}

// {"ID":"3119257c-da56-4df5-8cec-5375a3ba8c67","UserID":"21d4fa18-f86b-4aae-8c9d-975bc6e250bf","Stress1":"Kids",
// "Stress2":"Traffic","Stress3":"Crowds","Choice1":"Relaxation: muscle relaxation","Choice2":"Relaxation: muscle relaxation",
// "Choice3":"Self-contemplation","CreateTime":"2014-10-31T19:08:42.903","UpdateTime":"2014-10-31T19:08:42.903"}

function SetMatchingTitles(){

	$('#matchingTitle1').html(_matchedGroup[0]);
	$('#matchingTitle2').html(_matchedGroup[1]);
	$('#matchingTitle3').html(_matchedGroup[2]);
}

function SaveMatchingTool(){

	var matching1 = $('#matchingTitle1').html();
	var matching2 = $('#matchingTitle2').html();
	var matching3 = $('#matchingTitle3').html();

	var matching1Text = $('#matchingDrop1 option:selected').val();
	var matching2Text = $('#matchingDrop2 option:selected').val();
	var matching3Text = $('#matchingDrop3 option:selected').val();

	var tool = { UserID: _user.ID, Stress1: matching1, Stress2: matching2, Stress3: matching3, Choice1: matching1Text, Choice2: matching2Text, Choice3: matching3Text };
   	// alert(JSON.stringify(tool));
   	var hasItChanged = HasMatchingChanged(tool);

   	if(hasItChanged === true){
		ShowLoader();
		$('#matchingSaveBtn').prop('disabled', true);

		$.ajax({
	        type: "POST",
	        url: config.Path + '/matching/savetool',
	        data: tool
	    }).done(function(data){
			HideLoader();
			$('#matchingSaveBtn').prop('disabled', false);

			if (_isEmbeddedMatching){
				ShowNextPage(); // in contentengine...
				_isEmbeddedMatching = false;
			}
			else
	        	ShowHomePage();

			ShowSuccess('Matching Tool saved.');
	    });
	} else {
		ShowSuccess('Matching Tool saved.');
		
		if (_isEmbeddedMatching){
			ShowNextPage(); // in contentengine...
			_isEmbeddedMatching = false;
		}
		else
			ShowHomePage();
	}
}

function HasMatchingChanged(tool){
	if(_matchingFromDB==null){
		return true;
	}
	if(tool["Choice1"] != _matchingFromDB["Choice1"]){
		return true;
	} else if(tool["Choice2"] != _matchingFromDB["Choice2"]){
		return true;
	} else if(tool["Choice3"] != _matchingFromDB["Choice3"]){
		return true;
	} else if(tool["Stress1"] != _matchingFromDB["Stress1"]){
		return true;
	} else if(tool["Stress2"] != _matchingFromDB["Stress2"]){
		return true;
	} else if(tool["Stress3"] != _matchingFromDB["Stress3"]){
		return true;
	} else {
		return false;
	}
}
function BuildPopUpHTML(theClass){

	var htmlPopUp='';
	if(theClass.trim() == 'stress') {
		htmlPopUp = '<div class="col-xs-12" ><h2>Stress</h2></div><div class="col-xs-12 font300">Stress is something that is part of normal life and everyone experiences stress at some point in time. In some situations stress can be so frequent or severe that it impacts a person’s quality of life. Learning about your stress sources, triggers and symptoms will help when dealing with stress and learning how to relax. </div>';
	}
	else if(theClass.trim() == 'relax') {
		htmlPopUp = '<div class="col-xs-12" ><h2>Relaxation</h2></div><div class="col-xs-12 font300">Relaxation is one of the ways you can reduce the effect of stress in your life. When you relax, your body physically changes—you get what is called a “relaxation response". The goal of relaxation techniques is to release tension and reduce negative effects of stress, like depression, digestive disorders, headaches, high blood pressure, and insomnia.</div>';
	}
	else if(theClass.trim() == 'mindful') {
		htmlPopUp = '<div class="col-xs-12" ><h2>Mindfulness</h2></div><div class="col-xs-12 font300">Mindfulness is a way of improving your well-being, happiness and sense of fulfilment. It has been shown to reduce depression, anxiety, substance abuse and even pain. Mindfulness is all about awareness and presence. To be mindful, you focus on what you’re doing, thinking about, or feeling at every moment. It’s a deep level of paying attention.</div>';
	}
	else if (theClass.trim() == 'assertive'){
		htmlPopUp = '<div class="col-xs-12" ><span class="title bold">Tips for Assertiveness</span></div><div class="col-xs-12" >Use <span class="bold">clear</span> language to express your needs.</div><div class="col-xs-12" ><span class="bold">Respect</span> and consider the needs of all.</div><div class="col-xs-12" >Think about <span class="bold">non-verbal</span> communication.</div><div class="col-xs-12" >Speak at a normal conversation <span class="bold">volume</span>.</div>';
		htmlPopUp+= '<div class="col-xs-12" >How you say it is as important as what you say.</div><div class="col-xs-12" >Use <span class="bold">facts</span> and try to avoid exaggerating.</div><div class="col-xs-12" >Remember to <span class="bold">listen</span> as well.</div><div class="col-xs-12" >Use <span class="bold">"I statements"</span> to tell how you feel.</div><div class="col-xs-12 toolButton btnToolNext assertivePopUpFinished" ><span>Close</span><i class = "fa fa-caret-right"></i></div>';
	}

	// else if (theClass.trim() == 'howThoughtsFeel'){
	// 	htmlPopUp = '<div class="col-xs-12"><div class="font700">How do these thoughts make me feel?</div><div class="font300">Check all that apply.</div><div class="col-xs-6"><div class="font300">Anxious<div class="roundedCheckbox"><input type="checkbox" value="None" name="check" id="thoughtsAnxious" /><label for="thoughtsAnxious"></label></div></div></div></div>';
	// }

	$('.popUpText').html(htmlPopUp);
}

// <div class="col-xs-12"><div class="font700">How do these thoughts make me feel?</div><div class="font300">Check all that apply</div><div class="col-xs-6"><div class="roundedCheckbox"><input type="checkbox" value="None" name="check" id="thoughtsAnxious" /><label for="thoughtsAnxious" /></div></div></div>

// <div class="col-xs-12"><div class="font700">How do these thoughts make me feel?</div><div class="font300">Check all that apply</div>
// 	<div class="col-xs-6">
//		<div class="font300"> Anxious
// 			<div class="roundedCheckbox">
// 				<input type="checkbox" value="None" name="check" id="thoughtsAnxious" />
// 				<label for="thoughtsAnxious" ></label>
// 			</div>
// 		</div>
// 	</div>
//</div>

