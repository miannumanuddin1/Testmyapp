var _pick3 = [];
var _motivationTool;

function InitializeMotivation(){
	$('#motivationToolBtn').on('click', function(){
		LoadMotivation(function(){
			ShowyClose('#pageMotivationTool');
		}); //set values, if any
	});

	$('#motivationNextBtn').on('click', function(){
		var motivations = GatherPick3();
		if(motivations.length != 3){
			ShowError("Please choose 3.");
			_pick3 = [];
			return;
		}

		if (!_isEmbeddedMotivation) {
			MovePageLeft('#pageMotivationGoal', _currentPage);
			return;
		}

		// we are embedded...need to save and go back to Marvin
		var mt = _motivationTool;

		mt.Meaningful1 = _pick3[0];
		mt.Meaningful2 = _pick3[1];
		mt.Meaningful3 = _pick3[2];
		mt.MattersOptional = $('#motivationMattersOptional').val();

		SaveMotivationTool(mt, function(){
			ShowNextPage(); // in mevii-contentengine
		});
	});

	$('#motivationPrev').on('click', function(){
		MovePageRight('#pageMotivationTool', _currentPage);
		_pick3 = [];
	});

	$('#motivation2ndPrev').on('click', function(){
		MovePageRight('#pageMotivationGoal', _currentPage);
	});

	$('#motivation2ndNextBtn').on('click', function(){
		if (!_isEmbeddedMotivation) {
			var reason = $('#motivationReason option:selected').val();
			if (reason == 'Select one'){
				ShowError('Please select one.');
				return;
			}
			MovePageLeft('#pageMotivationStrengths', _currentPage);
			return;
		}

		// we are embedded...need to save and go back to Marvin
		var reason = $('#motivationReason option:selected').val();
		var mt = _motivationTool;
		mt.Reason = reason;
		mt.GoalsOptional = $('#motivationGoalOptional').val()

		SaveMotivationTool(mt, function(){
			ShowNextPage(); // in mevii-contentengine
		});
	});

	$('#motivationDone').on('click', function(){

		var strengths = GatherStrengths();
		if (strengths.length == 0){
			ShowError("Please select at least one strength.");
			return;
		}

		var mt = null;

		if (!_isEmbeddedMotivation) {
			var MattersOptional = $('#motivationMattersOptional').val();
			var StrengthsOptional = $('#motivationStrengthsOptional').val();
			var GoalsOptional = $('#motivationGoalOptional').val();
			var reason = $('#motivationReason option:selected').val();
			mt = { userID: _user.ID, Strengths: strengths, Reason: reason, Meaningful1: _pick3[0], Meaningful2: _pick3[1], Meaningful3: _pick3[2],
				   StrengthsOptional: StrengthsOptional, GoalsOptional: GoalsOptional, MattersOptional: MattersOptional };
		}
		else {
			mt = _motivationTool;
			mt.Strengths = strengths;
			mt.StrengthsOptional = $('#motivationStrengthsOptional').val();
		}

		SaveMotivationTool(mt, function(){
			if (_isEmbeddedMotivation)
				ShowNextPage(); // in mevii-contentengine
			else {
				ShowSuccess("Motivation Tool saved.");
				ShowHomePage();
			}
		});
	});

	$('.motivationBtn').on('click', function(){
		if($(this).hasClass('opacity50')){
			$(this).removeClass('opacity50');
		} else {
			$(this).addClass('opacity50');
		}
	});

	$('.strengthBtn').on('click', function(){
		if($(this).hasClass('opacity50')){
			$(this).removeClass('opacity50');
		} else {
			$(this).addClass('opacity50');
		}
	});
}

function LoadMotivation(callback){
	ShowLoader();

	$.ajax({
		type: "GET",
		url: config.Path + '/motivation/gettool',
		data: { userID: _user.ID }
	}).done(function(data){
		if(data === null){
			HandleError("motivation/gettool returned null");
			return;
		}

		_motivationTool = data;

    	$('#motivationMeaningful').children('div').each(function(){

			var title = $(this).children('.motivationTitle').html();

				if(title == data["Meaningful1"]){
					$(this).removeClass('opacity50');
				} else if(title == data["Meaningful2"]){
					$(this).removeClass('opacity50');
				} else if(title == data["Meaningful3"]){
					$(this).removeClass('opacity50');
				}
	    });

	    $('#motivationReason').val(data["Reason"]).attr('selected', 'selected');
		$('#motivationMattersOptional').val(data["MattersOptional"]);
		$('#motivationStrengthsOptional').val(data["StrengthsOptional"]);
		$('#motivationGoalOptional').val(data["GoalsOptional"]);

	    // alert(data["Strengths"]);
	    var strengths = data["Strengths"];
		if (strengths !== null) {
			strengths = strengths.split(",");
			var length = strengths.length;

			$('#motivationStrengths').find('.strengthBtn').each(function(){

				var title = $(this).children('.strengthTitle').html().trim();
				var s = 0;
				for(s=0; s<length; s++){
					if(title==strengths[s].trim()){
						$(this).closest('.strengthBtn').removeClass('opacity50');
					}
				}
			});
		}


		if (_isEmbeddedMotivation){
			$('#motivationPrev, #motivation2ndPrev').hide();
		}
		else {
			$('#motivationPrev, #motivation2ndPrev').show();
		}

		HideLoader();

		if (typeof callback != "undefined" && callback !== null)
			callback();

	}); // end .done

	// // "Meaningful1":"Creativity, music, art","Meaningful2":"Friends","Meaningful3":"Learning, education","Reason":"Spirituality",
	// // "Strengths":"Considerate,Determined,Funny,Good-humored,Kind,Open-minded,Patient,Resourceful,Strong"

}

function GatherPick3(){
	_pick3 = [];

	$('#motivationMeaningful').children('div').each(function(){
		var title = $(this).children('.motivationTitle').html();
		if(!$(this).hasClass('opacity50')){
			_pick3.push(title);
		}
	});

	return _pick3;
}

function GatherStrengths(){
	var strengths = [];

	$('#motivationStrengths').find('.strengthBtn').each(function(){
		var title = $(this).children('.strengthTitle').text().trim();
		if(!$(this).hasClass('opacity50')){
			strengths.push(title);
		}
	});

	strengths = strengths.toString();
	return strengths;
}

function SaveMotivationTool(mt, callback){
	ShowLoader();

	// if this is a new MT, then it won't have a UserID yet...
	if (mt.UserID != _user.ID)
		mt.UserID = _user.ID;

	$('#motivationDone').prop('disabled', true);

	$.ajax({
		type: "POST",
		url: config.Path + '/motivation/savetool',
		data: mt
	}).done(function(data){
		HideLoader();
		$('#motivationDone').prop('disabled', false);
		_pick3 = [];

		if (data === null){
			HandleError("Motivation/SaveTool returned null");
			return;
		}

		if (typeof callback != "undefined" && callback !== null)
			callback();
	});

}

