var _assertiveID = "";

function InitializeAssertive(){

	$('#assertiveAddBtn').on('click', function(){
		MovePageLeft('#pageAssertiveForm', _currentPage);
	});

	$('#assertiveSaveBtn').on('click', function(){
		SaveAssertiveForm();
		ShowOpportunities();
	});

	$('#assertiveCancelBtn').on('click', function(){
		MovePageRight('#pageAssertive', _currentPage);
		ClearAssertiveForm();
	});

	$('#assertiveDoneBtn').on('click', function(){
		if(_callAssertiveTool == "pageType"){
			_callAssertiveTool = "";
			ShowNextPage();
		} else {
			_callAssertiveTool = "";
			ShowHomePage();
		}
		
	});

	$('.assertiveInfo1').on('click', function(){
		MovePageUp('#pageAssertivePopUp', '#pageAssertiveForm');
		BuildPopUpHTML('assertive');

		$('.assertivePopUpFinished').on('click', function(){
			MovePageDown('#pageAssertiveForm', '#pageAssertivePopUp');
		});

	});

	$('.assertiveInfo2').on('click', function(){
		MovePageUp('#pageAssertivePopUp', '#pageAssertive');
		BuildPopUpHTML('assertive');

		$('.assertivePopUpFinished').on('click', function(){
			MovePageDown('#pageAssertive', '#pageAssertivePopUp');
		});
	});

	// $('.assertiveTitleWrapper').on('click', function(){
	// 	ResetAssertiveClicks();
	// });
	$('#assertiveDeleteBtn').on('click', function(){
		DeleteAssertive();
	});

}
function DeleteAssertive(){
 	$.ajax({
		type:"POST",
		url: config.Path + '/assertive/deletetool',
		data: {ID: _assertiveID}
	}).done(function(data){
		if (data === null)
			HandleError("Assertive Tool delete encountered a problem. Try again.");
		else{
			ClearAssertiveForm();
			ShowSuccess('Deleted.');
			ShowOpportunities();
			MovePageRight('#pageAssertive', _currentPage);
		}
 	});
}

function SaveAssertiveForm(){

	var opportunity = $('#assertiveOpportunityText').val();
	var expression = $('#assertiveExpressionText').val();

	if(opportunity === ""){
		$('#assertiveOpportunityText').focus();
		ShowError('Fields cannot be blank.');
		return;
	}

	if(expression === ""){
		$('#assertiveExpressionText').focus();
		ShowError('Fields cannot be blank.');
		return;
	}

	$('#assertiveSaveBtn').prop('disabled', true);

	if (_assertiveID !== ""){
		var assertiveData = { ID: _assertiveID, UserID: _user.ID, Opportunity: opportunity, Expression: expression };
	} else {
		var assertiveData = { UserID: _user.ID, Opportunity: opportunity, Expression: expression };
	}
	// alert(JSON.stringify(assertiveData));
	$.ajax({
		type: "POST",
		url: config.Path + '/assertive/savetool',
		data: assertiveData
	}).done(function(data){

		$('#assertiveSaveBtn').prop('disabled', false);

		_assertiveID = "";
		ClearAssertiveForm();
		ShowOpportunities();
		ShowSuccess("Saved.");

		MovePageRight('#pageAssertive', _currentPage);

	});
}

function ClearAssertiveForm(){
	$('#assertiveOpportunityText').val('');
	$('#assertiveExpressionText').val('');

}

function EditAssertive(e){

	var id = $(e).attr('id');
	var accordion = $(e).prev();
	_assertiveID = id;

    var title = accordion.find('.assertiveTitle');
    var titleText = $(title).html();
    // alert(titleText);
    $('#assertiveOpportunityText').val(titleText);

    var opportunity = accordion.find('.assertiveExpression');
    var opportunityText = $(opportunity).html();
    // alert(opportunityText);
    $('#assertiveExpressionText').val(opportunityText);

    MovePageLeft('#pageAssertiveForm', _currentPage);

}

function ShowOpportunities(){
	$.ajax({
		type: "GET",
		url: config.Path + '/assertive/gettool',
		data: { UserID: _user.ID }
	}).done(function(data){

		$('#assertiveAccordion').html("");
		// alert(JSON.stringify(data));
		var length = data.length;
		var i = 0;

		for(i=0; i<length; i++){ //build all the accordions

			var title = data[i].Opportunity;
			var expression = data[i].Expression;
			var id = data[i].ID;

	        var accordion = $('#assertiveTemplate').html();
	        accordion = accordion.replace('%%ACCORDION%%', id);

	        $('#assertiveAccordion').append(accordion);

	        var panel = $('#assertiveAccordion .panel:last-child');
	        panel.find('.panel-collapse').attr('id', id);

	        title = '<span class="assertiveTitle">' + title + '</span>';
	        var icon = '<i class="iconAccordion fa fa-caret-left"></i>';
	        panel.find('.assertiveTitleWrapper').html(title + icon);
	        // panel.find('.assertiveOpportunity').html(title);
	        panel.find('.assertiveExpression').html(expression);

	        $('#assertiveAccordion').append('<p class="assertiveEditBtn" id="' + id + '">Edit</p>');

	        $('.assertiveEditBtn').off();
	        $('.assertiveEditBtn').on('click', function(){
	        	EditAssertive(this);
	        });

		} // end for loop/building of accordions

			$('.collapse').on('show.bs.collapse', function(){
				var i = $(this).parent().find('i')
				i.toggleClass('fa-caret-left fa-caret-down');
			}).on('hide.bs.collapse', function(){
				var i = $(this).parent().find('i')
				i.toggleClass('fa-caret-down fa-caret-left');
			});

	}); //end .done
}

